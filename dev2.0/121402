<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Îπ†Î•∏ Ï£ºÎ¨∏ ÏãúÎÆ¨Î†àÏù¥ÏÖò</title>
    <style>
        /* --- Reset & Base Styles --- */
        * { box-sizing: border-box; margin: 0; padding: 0; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif; -webkit-tap-highlight-color: transparent; }
        body { background-color: #f5f5f5; display: flex; justify-content: center; min-height: 100vh; color: #333; }
        
        /* --- Mobile Container Layout --- */
        .app-container {
            width: 100%; max-width: 480px; background-color: #fff; position: relative;
            box-shadow: 0 0 20px rgba(0,0,0,0.05); overflow: hidden; display: flex; flex-direction: column; height: 100vh;
        }

        /* --- Colors & Vars --- */
        :root { 
            --primary: #008f3e; 
            --primary-dark: #007a35;
            --gray-text: #666; 
            --border: #eef1f4; 
            --bg-gray: #f9f9f9; 
            --blue-btn: #eef6ff; 
            --blue-text: #2d70f3; 
            --red-point: #ff4b4b;
        }

        /* --- Icons (SVG) --- */
        .icon { width: 24px; height: 24px; fill: none; stroke: currentColor; stroke-width: 2; stroke-linecap: round; stroke-linejoin: round; }

        /* --- Header --- */
        header { height: 56px; padding: 0 16px; display: flex; justify-content: space-between; align-items: center; background: #fff; z-index: 10; }
        .header-title { font-size: 20px; font-weight: 800; color: var(--primary); letter-spacing: -0.5px; }
        .header-btn { background: none; border: none; padding: 8px; margin: -8px; cursor: pointer; color: #333; }
        
        /* NEW: Header Link Button Style */
        .header-link-btn {
            display: flex;
            align-items: center;
            background: none;
            border: none;
            padding: 8px;
            margin: -8px;
            cursor: pointer;
            color: #333;
            text-decoration: none; /* For anchor tag behavior */
        }
        .header-link-text {
            margin-left: 6px;
            font-size: 15px;
            font-weight: 700;
            color: #333;
        }

        /* --- Tab Bar Wrapper (Fixed Segment Layout) */
        .tab-nav-wrapper {
            display: flex;
            align-items: center;
            border-bottom: 1px solid var(--border);
            background: #fff;
            width: 100%;
            height: 48px; /* Fixed height */
        }

        /* Fixed Width Container for Tabs */
        .tab-fixed-container {
            flex: 1; /* Take up all remaining space */
            display: flex;
            height: 100%;
        }

        /* Equal Width Tabs */
        .tab { 
            flex: 1; /* Equal distribution 1/N */
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 13px; /* Slightly reduced for fit */
            color: #999; 
            cursor: pointer; 
            font-weight: 500; 
            transition: all 0.2s;
            position: relative;
            white-space: nowrap;
            letter-spacing: -0.5px; /* Tighten text */
            padding: 0 2px; /* Minimal padding */
        }
        
        /* Active Indicator */
        .tab.active { 
            color: var(--primary); 
            font-weight: 800; 
            /* Full width bottom border for active tab */
        }
        .tab.active::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 0;
            width: 100%;
            height: 3px;
            background-color: var(--primary);
        }

        /* Fixed Edit Button */
        .tab-fixed-btn { 
            width: 44px; /* Fixed width for button */
            height: 100%;
            display: flex; 
            align-items: center; 
            justify-content: center; 
            border-left: 1px solid var(--border); 
            color: #aaa; 
            background: #fff; 
            cursor: pointer;
            flex-shrink: 0; /* Prevent shrinking */
        }

        /* --- Sort Control (Inline Style) --- */
        .sort-control {
            display: flex; align-items: center; font-size: 13px; color: #888; font-weight: 400; margin-right: 8px;
        }
        .sort-option { cursor: pointer; }
        .sort-option.active { color: #333; font-weight: 700; }
        .sort-divider { color: #ddd; margin: 0 6px; font-size: 10px; }

        /* --- Search Area (Toggle) --- */
        .search-area { padding: 12px 16px; background: #fff; border-bottom: 1px solid var(--border); display: none; animation: slideDown 0.2s ease-out; }
        @keyframes slideDown { from { transform: translateY(-10px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
        
        .search-box-wrapper { display: flex; align-items: center; gap: 10px; }
        .search-input-box { flex: 1; display: flex; align-items: center; border: 2px solid var(--primary); border-radius: 8px; padding: 8px 12px; height: 44px; }
        .search-input-box input { flex: 1; border: none; outline: none; font-size: 16px; margin-left: 8px; }
        .search-cancel { font-size: 15px; color: #666; cursor: pointer; padding: 5px; white-space: nowrap; }

        /* --- Content Area --- */
        .content-scroll { flex: 1; overflow-y: auto; background: #fff; padding-bottom: 140px; /* nav(60) + footer(72) + buffer */ }
        
        /* Category Styles */
        .category-section { border-bottom: 8px solid #f5f5f5; }
        .category-section:last-child { border-bottom: none; }
        
        .category-header { 
            padding: 16px; font-size: 15px; color: #333; font-weight: 700; 
            border-bottom: 1px solid var(--border); background: #fff; 
            display: flex; justify-content: space-between; align-items: center;
            cursor: pointer; /* Restore pointer */
            user-select: none;
        }
        .category-header span { color: #888; font-weight: 400; margin-left: 4px; }
        
        /* NEW: Minimal Catalog Header Style for LIST 1, 2, 3 (Accordion clickable for LIST 1/Special category sort) */
        .category-header.catalog-header {
            padding: 8px 16px; /* Reduced vertical padding */
            border-bottom: 1px solid #f0f0f0; 
            background: #fcfcfc; 
            font-size: 14px;
            font-weight: 600;
            cursor: pointer; /* Restore cursor for toggle */
        }
        .category-header.catalog-header.flat-list {
            cursor: default; /* Disable click for saved list headers when sorted by category (LIST 2/3) */
        }

        .category-section.catalog-section {
            border-bottom: 1px solid #f5f5f5; /* Use a lighter separator */
        }
        /* End NEW CSS */
        
        /* Arrow Rotation Logic */
        .category-arrow { transition: transform 0.3s; color: #aaa; }
        .category-arrow { transform: rotate(0deg); } 
        .category-header.open .category-arrow { transform: rotate(180deg); }

        .category-header-right { display: flex; align-items: center; }

        .category-items { display: none; }
        .category-items.open { display: block; animation: expandList 0.3s ease-out; }
        
        @keyframes expandList {
            from { opacity: 0; transform: translateY(-5px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* --- Product List Item --- */
        .product-item { display: flex; padding: 16px; border-bottom: 1px solid var(--border); }
        
        .prod-img { width: 70px; height: 70px; background: #f0f0f0; border-radius: 8px; margin-right: 16px; display: flex; align-items: center; justify-content: center; font-size: 32px; flex-shrink: 0; position: relative; overflow: hidden;}
        .prod-img img { width: 100%; height: 100%; object-fit: cover; }
        
        .prod-info { flex: 1; display: flex; flex-direction: column; justify-content: center; min-width: 0; }
        .prod-name { font-size: 16px; font-weight: 600; margin-bottom: 6px; color: #222; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
        .prod-unit { font-size: 13px; color: #999; margin-bottom: 6px; }
        .prod-price { font-size: 16px; font-weight: 800; color: var(--primary); }
        .prod-tag { display: inline-block; font-size: 11px; color: #ff6b6b; border: 1px solid #ff6b6b; padding: 1px 4px; border-radius: 3px; margin-bottom: 4px; width: fit-content;}

        /* --- Quantity Control --- */
        .qty-control { display: flex; align-items: center; border: 1px solid #e0e0e0; border-radius: 6px; height: 36px; margin-left: 10px; background: #fff; overflow: hidden; }
        .qty-btn { width: 32px; height: 100%; border: none; background: #f8f9fa; cursor: pointer; display: flex; align-items: center; justify-content: center; color: #555; font-size: 18px; transition: background 0.1s; }
        .qty-btn:active { background: #e9ecef; }
        .qty-val { width: 36px; text-align: center; font-size: 15px; font-weight: 600; color: #333; }

        /* --- Search Section Headers --- */
        .search-section-header {
            padding: 12px 16px; background: #f0f2f5; color: #555; font-size: 14px; font-weight: 700; border-bottom: 1px solid #e0e0e0;
        }
        
        /* Load More Button Style */
        .search-more-btn {
            display: flex; justify-content: center; align-items: center; width: 100%; padding: 16px; 
            background: #fff; color: #555; border: none; border-bottom: 1px solid #f0f0f0;
            font-size: 14px; font-weight: 600; cursor: pointer; transition: background 0.2s;
        }
        .search-more-btn:active { background: #f9f9f9; }
        .search-more-btn::after {
            content: ''; display: inline-block; margin-left: 6px; width: 8px; height: 8px;
            border-right: 2px solid #aaa; border-bottom: 2px solid #aaa; transform: rotate(45deg); margin-top: -4px;
        }

        /* --- Toast Message --- */
        .toast-msg {
            position: fixed; bottom: 140px; left: 50%; transform: translateX(-50%);
            background: rgba(0,0,0,0.8); color: #fff; padding: 10px 20px; border-radius: 20px;
            font-size: 14px; z-index: 2000; opacity: 0; transition: opacity 0.3s; pointer-events: none;
        }
        .toast-msg.show { opacity: 1; }

        /* --- Footer (Order Bar) - Adjusted for Bottom Nav --- */
        .footer-bar {
            position: absolute; bottom: 60px; /* Above Bottom Nav */
            left: 0; right: 0; background: #fff; border-top: 1px solid #e0e0e0; 
            padding: 12px 16px; display: flex; align-items: center; height: 72px; z-index: 50; 
            box-shadow: 0 -4px 10px rgba(0,0,0,0.03);
        }
        .delivery-info { margin-right: auto; line-height: 1.3; }
        .delivery-label { font-size: 12px; color: #666; }
        .delivery-date { font-size: 15px; color: var(--blue-text); font-weight: 700; }
        
        .order-btn {
            background: #b0b8c1; color: #fff; border: none; padding: 0 24px; height: 48px; border-radius: 8px; 
            font-weight: 700; font-size: 16px; cursor: not-allowed; min-width: 200px; box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            transition: background 0.2s;
        }
        .order-btn.active { background: #50555c; cursor: pointer; } 

        /* --- Bottom Navigation Bar (Text Removed) --- */
        .bottom-nav {
            position: absolute; bottom: 0; left: 0; width: 100%; height: 60px;
            background: #fff; border-top: 1px solid #eee; display: flex;
            justify-content: space-around; align-items: center; z-index: 60;
        }
        .nav-item {
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            width: 100%; height: 100%; color: #999; cursor: pointer;
            -webkit-tap-highlight-color: transparent;
        }
        .nav-item.active { color: var(--primary); }
        .nav-item svg { width: 24px; height: 24px; stroke-width: 2; }
        /* Removed .nav-item span styles */
        
        /* Kakao Icon Color Override */
        .nav-item.kakao svg { fill: #3c1e1e; stroke: none; }
        .nav-item.kakao.active { color: #3c1e1e; }


        /* --- SPA Modal (Full Screen) --- */
        .modal-spa {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #f5f5f5; z-index: 2000;
            display: flex; flex-direction: column; transform: translateX(100%); transition: transform 0.3s cubic-bezier(0.16, 1, 0.3, 1);
        }
        .modal-spa.open { transform: translateX(0); }
        
        .modal-header { height: 56px; padding: 0 16px; background: #fff; display: flex; align-items: center; border-bottom: 1px solid #eee; }
        .modal-back-btn { background: none; border: none; padding: 8px; margin-left: -8px; margin-right: 8px; cursor: pointer; }
        .modal-title { font-size: 18px; font-weight: 700; flex: 1; }
        .modal-action { font-size: 14px; color: #666; font-weight: 500; cursor: pointer; }

        .modal-content { flex: 1; overflow-y: auto; padding-bottom: 80px; }
        
        .modal-item { background: #fff; padding: 16px; margin-bottom: 1px; display: flex; align-items: center; cursor: pointer; }
        .modal-item:active { background: #f9f9f9; }
        .modal-checkbox { 
            width: 24px; height: 24px; border: 2px solid #ddd; border-radius: 4px; margin-left: auto; 
            display: flex; align-items: center; justify-content: center; transition: all 0.2s;
        }
        .modal-checkbox.checked { background: var(--primary); border-color: var(--primary); }
        .modal-checkbox.checked::after { content: ''; width: 6px; height: 10px; border: solid white; border-width: 0 2px 2px 0; transform: rotate(45deg) translateY(-1px); }

        .modal-confirm-container {
            position: absolute; bottom: 30px; left: 0; right: 0; padding: 0 20px; text-align: center; pointer-events: none;
        }
        .modal-confirm-btn {
            background: var(--primary); color: #fff; border: none; padding: 16px; width: 100%; border-radius: 30px;
            font-size: 16px; font-weight: 700; box-shadow: 0 5px 15px rgba(0, 143, 62, 0.4); 
            cursor: pointer; pointer-events: auto; transform: translateY(100px); transition: transform 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }
        .modal-confirm-btn.visible { transform: translateY(0); }

        /* Empty State */
        .empty-state { text-align: center; padding: 60px 20px; color: #999; font-size: 15px; }

    </style>
</head>
<body>

    <div class="app-container">
        <!-- Main Header -->
        <header>
            <button class="header-link-btn" onclick="window.location.href='https://nhline.co.kr/'">
                <svg class="icon" viewBox="0 0 24 24"><path d="M3 12h18M3 6h18M3 18h18"></path></svg>
                <span class="header-link-text">NHÎùºÏù∏</span>
            </button>
            <div class="header-title">Ïò§ÎçîÏ¶à</div>
            <div class="header-btn" style="font-size: 14px; font-weight: bold; color: #666;">OP</div>
        </header>

        <!-- Search Bar (Initially Hidden) -->
        <div class="search-area" id="searchArea">
            <div class="search-box-wrapper">
                <div class="search-input-box">
                    <svg class="icon" style="width:20px; height:20px; color:#aaa;" viewBox="0 0 24 24"><circle cx="11" cy="11" r="8"></circle><line x1="21" y1="21" x2="16.65" y2="16.65"></line></svg>
                    <input type="text" id="localSearchInput" placeholder="ÏÉÅÌíàÎ™Ö Í≤ÄÏÉâ (Ïòà: Î¨¥)" autocomplete="off">
                </div>
                <div class="search-cancel" onclick="toggleSearch()">Ï∑®ÏÜå</div>
            </div>
        </div>

        <!-- NEW Tab Bar Structure: FIXED SEGMENT LAYOUT -->
        <div class="tab-nav-wrapper">
            <div class="tab-fixed-container">
                <div class="tab" id="tab-special" onclick="switchTab('special')">Îã®Í≥®ÌäπÍ∞Ä</div>
                <!-- LIST 1 is the main catalog view -->
                <div class="tab active" id="tab-list1" onclick="switchTab('list1')">LIST 1</div>
                <div class="tab" id="tab-list2" onclick="switchTab('list2')">LIST 2</div>
                <div class="tab" id="tab-list3" onclick="switchTab('list3')">LIST 3</div>
            </div>
            
            <!-- Fixed Edit Button -->
            <div class="tab-fixed-btn" onclick="alert('Ìé∏Ïßë/ÏÑ§Ï†ï ÌôîÎ©¥ÏúºÎ°ú Ïù¥ÎèôÌï©ÎãàÎã§.')">
                <svg class="icon" style="width:18px; height:18px;" viewBox="0 0 24 24">
                    <line x1="4" y1="21" x2="4" y2="14"></line><line x1="4" y1="10" x2="4" y2="3"></line>
                    <line x1="12" y1="21" x2="12" y2="12"></line><line x1="12" y1="8" x2="12" y2="3"></line>
                    <line x1="20" y1="21" x2="20" y2="16"></line><line x1="20" y1="12" x2="20" y2="3"></line>
                    <line x1="1" y1="14" x2="7" y2="14"></line><line x1="9" y1="8" x2="15" y2="8"></line>
                    <line x1="17" y1="16" x2="23" y2="16"></line>
                </svg>
            </div>
        </div>

        <!-- Main Content Scroll Area -->
        <div class="content-scroll" id="scrollContainer">
            <div id="mainContentArea"></div>

            <div class="global-search-suggestion" id="globalSearchSuggestion">
                <div class="global-search-text">Ï∞æÏúºÏãúÎäî ÏÉÅÌíàÏù¥ Î¶¨Ïä§Ìä∏Ïóê ÏóÜÎÇòÏöî?</div>
                <button class="global-search-btn" id="globalSearchBtn" onclick="openGlobalSearch()">
                    Ï†ÑÏ≤¥ ÏÉÅÌíàÏóêÏÑú Í≤ÄÏÉâÌïòÍ∏∞
                </button>
            </div>
        </div>

        <!-- Order Action Bar -->
        <div class="footer-bar">
            <div class="delivery-info">
                <div class="delivery-label">Î∞∞ÏÜ°ÏòàÏ†ïÏùº</div>
                <div class="delivery-date">2025-10-20 (Ïõî)</div>
            </div>
            <button class="order-btn" id="mainOrderBtn" onclick="processOrder()">Ï£ºÎ¨∏Ìï† ÏÉÅÌíàÏùÑ Îã¥ÏïÑÏ£ºÏÑ∏Ïöî</button>
        </div>

        <!-- Bottom Navigation Bar -->
        <nav class="bottom-nav">
            <div class="nav-item active" onclick="handleNavClick('home')">
                <svg viewBox="0 0 24 24" class="icon" fill="none" stroke="currentColor">
                    <path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"></path>
                    <polyline points="9 22 9 12 15 12 15 22"></polyline>
                </svg>
            </div>
            <div class="nav-item" onclick="handleNavClick('search')">
                <svg viewBox="0 0 24 24" class="icon" fill="none" stroke="currentColor">
                    <circle cx="11" cy="11" r="8"></circle>
                    <line x1="21" y1="21" x2="16.65" y2="16.65"></line>
                </svg>
            </div>
            <div class="nav-item" onclick="handleNavClick('check')">
                <svg viewBox="0 0 24 24" class="icon" fill="none" stroke="currentColor">
                    <polyline points="9 11 12 14 22 4"></polyline>
                    <path d="M21 12v7a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11"></path>
                </svg>
            </div>
            <div class="nav-item kakao" onclick="handleNavClick('kakao')">
                <svg viewBox="0 0 24 24" class="icon">
                    <path d="M12 3c-5.52 0-10 3.58-10 8 0 2.86 1.89 5.4 4.85 6.86-.21.78-.77 2.82-.88 3.23a.62.62 0 0 0 .89.72c.36-.26 3.65-2.48 4.26-2.91.29.04.59.06.88.06 5.52 0 10-3.58 10-8s-4.48-8-10-8z" fill="#3c1e1e"></path>
                </svg>
            </div>
        </nav>
        
        <!-- Toast Message -->
        <div id="toast" class="toast-msg"></div>
    </div>

    <!-- SPA Modal: Global Search -->
    <div class="modal-spa" id="globalSearchModal">
        <div class="modal-header">
            <button class="modal-back-btn" onclick="closeGlobalSearch()">
                <svg class="icon" viewBox="0 0 24 24"><polyline points="15 18 9 12 15 6"></polyline></svg>
            </button>
            <div class="modal-title"><span style="color:#ff4b4b" id="modalSearchQuery"></span> Í≤ÄÏÉâ Í≤∞Í≥º</div>
            <div class="modal-action">Ï†ïÏßÄÏÉÅÌíàÎ≥¥Í∏∞</div>
        </div>
        
        <div class="modal-content" id="modalList">
            <!-- Modal Items -->
        </div>

        <div class="modal-confirm-container">
            <button class="modal-confirm-btn" id="modalConfirmBtn" onclick="confirmGlobalSelection()">
                ÏÑ†ÌÉù ÏÉÅÌíà Î¶¨Ïä§Ìä∏Ïóê Ï∂îÍ∞Ä
            </button>
        </div>
    </div>

    <script>
        // --- 1. Data Mockup ---
        const categoryData = [
            {
                id: 'veg',
                title: 'Ï±ÑÏÜå/Í≥ºÏùº', 
                isOpen: true, 
                items: [
                    { id: 2, name: "ÏñëÎ∞∞Ï∂î(ÎåÄ)42Îßù(3ÏûÖ) BOX", unit: "BOX", price: 10900, img: "ü•¶", tag: null },
                    { id: 3, name: "ÏñëÌåå_Ïôï20kgÎßù BOX", unit: "BOX", price: 22000, img: "üßÖ", tag: null },
                    { id: 5, name: "ÎåÄÌåå/ (Îã®) EA", unit: "EA", price: 3200, img: "üéã", tag: null },
                ]
            },
            {
                id: 'food',
                title: 'ÏãùÌíà,ÏùåÎ£å',
                isOpen: true, 
                items: [
                    { id: 10, name: "Ïò§ÎöúÍ∏∞_ÏßÑÎùºÎ©¥_Îß§Ïö¥Îßõ 30ÏûÖ", unit: "BOX", price: 24500, img: "üçú", tag: null },
                    { id: 11, name: "ÏΩîÏπ¥ÏΩúÎùº_ÏóÖÏÜåÏö© 1.25L", unit: "EA", price: 2100, img: "ü•§", tag: "Ïù∏Í∏∞" },
                ]
            },
            {
                id: 'sauce',
                title: 'ÏñëÎÖê,ÏÜåÏä§',
                isOpen: true, 
                items: [
                    { id: 20, name: "Î™ΩÍ≥†_ÏßÑÍ∞ÑÏû•_13L", unit: "CAN", price: 48000, img: "üè∫", tag: null },
                    { id: 21, name: "CJ_Ìï¥Ï∞¨Îì§_Í≥†Ï∂îÏû• 14kg", unit: "CAN", price: 52000, img: "üå∂Ô∏è", tag: null },
                    { id: 22, name: "Î∞±ÏÑ§_ÌïòÏñÄÏÑ§ÌÉï 15kg", unit: "ÂåÖ", price: 19800, img: "üßÇ", tag: null },
                    { id: 23, name: "Ïò§ÎöúÍ∏∞_ÏòõÎÇ†Ï∞∏Í∏∞Î¶Ñ", unit: "CAN", price: 32000, img: "üßà", tag: null },
                    { id: 24, name: "ÎØ∏Ïõê_2kg", unit: "EA", price: 9500, img: "üßÇ", tag: null },
                ]
            }
        ];

        // Special Event Products for 'Îã®Í≥®ÌäπÍ∞Ä'
        const specialData = [
            { id: 201, name: "[ÌñâÏÇ¨] Ìñá ÏñëÌåå 15kg", unit: "Îßù", price: 12000, img: "üßÖ", tag: "Ï¥àÌäπÍ∞Ä" },
            { id: 202, name: "[ÌñâÏÇ¨] Îã§Î∞úÎ¨¥ 1Îã®", unit: "Îã®", price: 4500, img: "ü•¨", tag: "ÌïúÏ†ïÏàòÎüâ" },
            { id: 203, name: "[Ïù¥Î≤§Ìä∏] Ïã†ÎùºÎ©¥ 30ÏûÖ", unit: "BOX", price: 21000, img: "üçú", tag: "ÌäπÍ∞Ä" }
        ];

        // Mocking a larger database for simulation
        const globalDatabase = [
            { id: 101, name: "Î¨¥Ïö∞_ÌäπÎ∞ïÏä§_10ÏûÖ BOX", unit: "BOX", price: 22800, img: "üì¶", tag: "ÌñâÏÇ¨", targetCat: 'veg' },
            { id: 102, name: "Î¨¥Ïö∞_ÏÉÅÎ∞ïÏä§ BOX", unit: "BOX", price: 17000, img: "üì¶", tag: null, targetCat: 'veg' },
            { id: 103, name: "Î¨¥Ïö∞(ÎÇ±Í∞ú)", unit: "EA", price: 2800, img: "ü•£", tag: null, targetCat: 'veg' },
            { id: 104, name: "Î¨¥ÏàúÏÜå_60gÌå© EA", unit: "EA", price: 500, img: "üå±", tag: null, targetCat: 'veg' },
            { id: 105, name: "ÏÇ∂ÏùÄÎ¨¥Ï≤≠ÏãúÎûòÍ∏∞_1kgX10 BOX", unit: "BOX", price: 27800, img: "ü•ò", tag: null, targetCat: 'veg' }
        ];

        // --- 2. State Management ---
        // List 1, 2, 3 items pre-populated with quantity 0
        let carts = {
            'special': {}, 
            'list1': {}, // Catalog view cart
            'list2': { 10: 0, 11: 0, 203: 0, 21: 0 }, // Saved List 2
            'list3': { 22: 0, 23: 0, 24: 0, 101: 0 } // Saved List 3
        };
        
        let selectedGlobalIds = new Set();
        let searchQuery = "";
        let currentTab = 'list1'; 
        let currentSort = 'newest'; // Default sort set to 'newest'
        
        const INITIAL_LIMIT = 3; 
        const LOAD_STEP = 3;
        let currentSearchLimit = INITIAL_LIMIT;

        // --- 3. DOM Elements ---
        const mainContentArea = document.getElementById('mainContentArea');
        const searchArea = document.getElementById('searchArea');
        const localInput = document.getElementById('localSearchInput');
        const suggestionBox = document.getElementById('globalSearchSuggestion');
        const modalEl = document.getElementById('globalSearchModal');
        const modalListEl = document.getElementById('modalList');
        const orderBtn = document.getElementById('mainOrderBtn');
        const scrollContainer = document.getElementById('scrollContainer');
        const toastEl = document.getElementById('toast');

        // Helper: Get Current Cart Key
        function getCurrentCartKey() {
            return currentTab; 
        }

        // Helper to determine category ID for an item ID
        function getCategoryId(itemId) {
            // Check main categories
            for (const cat of categoryData) {
                if (cat.items.find(i => i.id === itemId)) return cat.id;
            }
            // Check special data
            if (specialData.find(i => i.id === itemId)) return 'special_items';
            // Check global data
            if (globalDatabase.find(i => i.id === itemId)) return 'global_items';

            return 'unknown';
        }

        // --- 4. Content Rendering Logic ---
        
        function getSortControlHTML() {
            return `
                <div class="sort-control">
                    <span class="sort-option ${currentSort === 'category' ? 'active' : ''}" onclick="setSort(event, 'category')">Ïπ¥ÌÖåÍ≥†Î¶¨Ïàú</span>
                    <span class="sort-divider">|</span>
                    <span class="sort-option ${currentSort === 'newest' ? 'active' : ''}" onclick="setSort(event, 'newest')">ÏµúÏã†Ïàú</span>
                </div>
            `;
        }

        function setSort(e, mode) {
            e.stopPropagation();
            currentSort = mode;
            renderContent();
        }

        function renderContent() {
            mainContentArea.innerHTML = '';

            // 1. Search Mode Priority
            if (searchQuery) {
                renderSearchResults();
                return;
            }

            // 2. Tab Logic
            if (currentTab === 'special' || currentTab === 'list1') {
                // RENDER Catalog/Special Tab Content
                
                // Sort Control Header
                const headerDiv = document.createElement('div');
                headerDiv.className = 'category-header';
                headerDiv.style.cursor = 'default';
                headerDiv.style.justifyContent = 'flex-end'; 
                headerDiv.style.borderBottom = '1px solid #eef1f4';
                headerDiv.innerHTML = getSortControlHTML();
                mainContentArea.appendChild(headerDiv);

                if (currentTab === 'special') {
                    if (currentSort === 'category') {
                        // FIX: Wrap specialData in a category object before passing.
                        const specialCategoryWrapper = [{ id: 'special', title: 'Îã®Í≥® ÌäπÍ∞Ä ÏÉÅÌíà', items: specialData, isOpen: true }];
                        renderCategoryView(specialCategoryWrapper);
                    } else {
                        // Flat list view (default for Special when newest is selected)
                        renderAllItemsFlat(specialData, 'newest'); 
                    }
                } else if (currentTab === 'list1') {
                    if (currentSort === 'category') {
                        // FIX: Pass categoryData (array of category objects) directly.
                        renderCategoryView(categoryData);
                    } else {
                        // Flat list view (default for LIST 1 when newest is selected)
                        // Pass categoryData array to renderAllItemsFlat (which handles merging with specialData internally)
                        renderAllItemsFlat(categoryData, 'newest'); 
                    }
                }
            } else if (['list2', 'list3'].includes(currentTab)) {
                // RENDER Saved List View (LIST 2, LIST 3)
                renderFlatCartView(currentTab);
            }
        }

        // Modified: Handles both LIST 1 (categoryData) and Special (specialData) if sorted by category
        function renderCategoryView(categories) {
            // categories is now guaranteed to be an array of category objects (either categoryData or the specialData wrapper)
            
            categories.forEach(cat => {
                const section = document.createElement('div');
                section.className = 'category-section catalog-section'; 
                
                const header = document.createElement('div');
                // Use catalog-header style and re-add click handler/arrow for accordion
                header.className = `category-header catalog-header ${cat.isOpen ? 'open' : ''}`; 
                header.onclick = () => toggleCategory(cat.id);
                
                // HTML Content construction (minimal text + arrow)
                let leftContent = `<div>${cat.title} <span>(${cat.items.length})</span></div>`; 
                let rightContent = `<div class="category-header-right">
                    <svg class="icon category-arrow" viewBox="0 0 24 24"><polyline points="6 9 12 15 18 9"></polyline></svg>
                </div>`; 
                
                header.innerHTML = leftContent + rightContent; 
                
                const itemContainer = document.createElement('div');
                // Use open/close class logic
                itemContainer.className = `category-items ${cat.isOpen ? 'open' : ''}`; 
                
                cat.items.forEach(item => {
                    itemContainer.appendChild(createProductElement(item));
                });

                section.appendChild(header);
                section.appendChild(itemContainer);
                mainContentArea.appendChild(section);
            });
            suggestionBox.style.display = 'none';
        }

        // Modified to handle data input (used for flat view of LIST 1 and Special)
        function renderAllItemsFlat(initialData = categoryData, sortMode) {
            let allItems = [];
            // LIST 1 (catalog) combines main categories and special deals in flat view
            if (initialData === categoryData) {
                categoryData.forEach(cat => allItems.push(...cat.items));
                allItems = [...allItems, ...specialData]; 
            } else {
                allItems = initialData; // If running for 'specialData' directly
            }


            if (sortMode === 'newest') {
                allItems.sort((a, b) => b.id - a.id);
            }

            const container = document.createElement('div');
            allItems.forEach(item => {
                container.appendChild(createProductElement(item));
            });
            
            mainContentArea.appendChild(container);
            suggestionBox.style.display = 'none';
        }

        function renderFlatCartView(listKey) {
            suggestionBox.style.display = 'none';

            // 1. Collect ALL possible item details
            let allItems = [];
            categoryData.forEach(cat => allItems.push(...cat.items));
            allItems = [...allItems, ...globalDatabase, ...specialData]; 

            let allItemsMap = new Map();
            allItems.forEach(item => allItemsMap.set(item.id, item));

            const currentCart = carts[listKey] || {};
            const cartKeys = Object.keys(currentCart);

            // 2. Filter items present in the current saved list
            let cartItems = allItems.filter(item => cartKeys.includes(String(item.id)));
            
            if (cartItems.length === 0) {
                 mainContentArea.innerHTML = `
                    <div class="empty-state">
                        <svg class="icon" style="width:48px; height:48px; margin-bottom:12px; color:#ccc;" viewBox="0 0 24 24"><path d="M6 2L3 6v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2V6l-3-4z"></path><line x1="3" y1="6" x2="21" y2="6"></line><path d="M16 10a4 4 0 0 1-8 0"></path></svg>
                        <br>Î¶¨Ïä§Ìä∏Ïóê Îã¥Í∏¥ ÏÉÅÌíàÏù¥ ÏóÜÏäµÎãàÎã§.
                    </div>
                `;
                return;
            }
            
            // 3. Render main header (Total Count + Sort Controls)
            const headerDiv = document.createElement('div');
            headerDiv.className = 'category-header inbox-header'; 
            headerDiv.style.borderBottom = '1px solid #eee';
            headerDiv.style.cursor = 'default';
            let listName = listKey === 'list2' ? 'LIST 2' : 'LIST 3';

            headerDiv.innerHTML = `
                <div>${listName} ÏÉÅÌíà <span>(${cartItems.length})</span></div>
                <div class="category-header-right">
                    ${getSortControlHTML()}
                </div>
            `;
            mainContentArea.appendChild(headerDiv);

            // 4. Group or Flat Render based on currentSort
            if (currentSort === 'category') {
                
                // Group cart items by category
                const categoryGroups = {
                    'veg': { title: 'Ï±ÑÏÜå/Í≥ºÏùº', items: [] },
                    'food': { title: 'ÏãùÌíà,ÏùåÎ£å', items: [] },
                    'sauce': { title: 'ÏñëÎÖê,ÏÜåÏä§', items: [] },
                    'special_items': { title: 'Îã®Í≥®ÌäπÍ∞Ä', items: [] },
                    'global_items': { title: 'Ï†ÑÏ≤¥ÏÉÅÌíà', items: [] }
                };

                cartItems.forEach(item => {
                    const catId = getCategoryId(item.id);
                    if (categoryGroups[catId]) {
                        categoryGroups[catId].items.push(item);
                    }
                });

                // Render grouped items with category headers (Non-clickable)
                Object.values(categoryGroups).forEach(group => {
                    if (group.items.length > 0) {
                        const section = document.createElement('div');
                        section.className = 'category-section catalog-section';

                        // Category Header (Minimal style, NON-CLICKABLE in saved lists)
                        const catHeader = document.createElement('div');
                        catHeader.className = 'category-header catalog-header flat-list'; // flat-list prevents pointer
                        catHeader.innerHTML = `<div>${group.title} <span>(${group.items.length})</span></div>`;
                        section.appendChild(catHeader);

                        // Items list (Always open)
                        const itemContainer = document.createElement('div');
                        itemContainer.className = 'category-items open'; 
                        
                        // Sort items within the group by newest (ID)
                        group.items.sort((a, b) => b.id - a.id); 

                        group.items.forEach(item => {
                            itemContainer.appendChild(createProductElement(item));
                        });
                        section.appendChild(itemContainer);
                        mainContentArea.appendChild(section);
                    }
                });
            } else {
                // Default: Newest sort (Flat list)
                cartItems.sort((a, b) => b.id - a.id); 

                const container = document.createElement('div');
                cartItems.forEach(item => {
                    container.appendChild(createProductElement(item));
                });
                mainContentArea.appendChild(container);
            }
        }

        // Helper: Create Product Row
        function createProductElement(item) {
            const currentCart = carts[getCurrentCartKey()] || {};
            const qty = currentCart[item.id] || 0;
            
            const div = document.createElement('div');
            div.className = 'product-item';
            div.innerHTML = `
                <div class="prod-img">${item.img}</div>
                <div class="prod-info">
                    ${item.tag ? `<div class="prod-tag">${item.tag}</div>` : ''}
                    <div class="prod-name">${item.name}</div>
                    <div class="prod-unit">${item.unit}</div>
                    <div class="prod-price">${item.price.toLocaleString()}Ïõê</div>
                </div>
                <div class="qty-control">
                    <button class="qty-btn" onclick="updateQty(${item.id}, -1)">-</button>
                    <div class="qty-val" id="qty-${item.id}">${qty}</div>
                    <button class="qty-btn" onclick="updateQty(${item.id}, 1)">+</button>
                </div>
            `;
            return div;
        }

        function toggleCategory(catId) {
            // For LIST 1 and Special tabs, when sorted by category
            if (catId === 'special') {
                // If special is grouped by its own list (which isn't really a categoryData list)
                // We use the first category's state for a simple toggle across all categories
                const firstCat = categoryData[0]; 
                firstCat.isOpen = !firstCat.isOpen;
                categoryData.forEach(c => c.isOpen = firstCat.isOpen); 
            } else {
                const cat = categoryData.find(c => c.id === catId);
                if(cat) {
                    cat.isOpen = !cat.isOpen;
                }
            }
            renderContent();
        }

        // --- 5. Tab Logic ---
        function switchTab(tabName) {
            currentTab = tabName;
            
            const tabElements = {
                special: document.getElementById('tab-special'),
                list1: document.getElementById('tab-list1'), // Renamed from main
                list2: document.getElementById('tab-list2'),
                list3: document.getElementById('tab-list3')
            };

            Object.values(tabElements).forEach(el => {
                if(el) el.classList.remove('active');
            });

            if (tabElements[tabName]) {
                tabElements[tabName].classList.add('active');
            }

            if(searchQuery) {
                searchQuery = "";
                localInput.value = "";
                searchArea.style.display = 'none';
            }

            // Always reset to 'newest' sort when switching tabs, unless we are preserving state.
            currentSort = 'newest'; // Reset sort to default 'newest'
            
            scrollContainer.scrollTop = 0;
            
            renderContent();
            updateOrderButton();
        }

        // --- 6. Interaction Logic ---

        function updateQty(id, delta) {
            const cartKey = getCurrentCartKey();
            if(!carts[cartKey]) carts[cartKey] = {};
            
            if (!carts[cartKey][id]) carts[cartKey][id] = 0;
            
            carts[cartKey][id] += delta;
            if(carts[cartKey][id] < 0) carts[cartKey][id] = 0;

            const qtyEls = document.querySelectorAll(`#qty-${id}`);
            qtyEls.forEach(el => el.innerText = carts[cartKey][id]);

            updateOrderButton();
        }

        function updateOrderButton() {
            let totalCount = 0;
            let totalPrice = 0;
            
            // Collect ALL product info to look up prices
            let allItems = [];
            categoryData.forEach(cat => allItems.push(...cat.items));
            allItems = [...allItems, ...globalDatabase, ...specialData];
            
            // Sum up quantities from ALL carts (tabs)
            Object.values(carts).forEach(cart => {
                Object.keys(cart).forEach(key => {
                    const pid = parseInt(key);
                    const qty = cart[pid];
                    if(qty > 0) {
                        const product = allItems.find(p => p.id === pid);
                        if(product) {
                            totalCount += qty;
                            totalPrice += product.price * qty;
                        }
                    }
                });
            });

            if (totalCount > 0) {
                orderBtn.classList.add('active');
                orderBtn.innerHTML = `[<span style="color:#fff">${totalCount}</span>Í∞ú] Îã¥ÏùÄ ÏÉÅÌíà ÌôïÏù∏ÌïòÍ∏∞`;
            } else {
                orderBtn.classList.remove('active');
                orderBtn.innerText = 'Ï£ºÎ¨∏Ìï† ÏÉÅÌíàÏùÑ Îã¥ÏïÑÏ£ºÏÑ∏Ïöî';
            }
        }

        function processOrder() {
            if (!orderBtn.classList.contains('active')) return;
            
            // Clear ALL Carts since order is global
            Object.keys(carts).forEach(key => {
                carts[key] = {};
            });
            
            // Update UI
            renderContent(); 
            updateOrderButton();
            
            showToast("Î™®Îì† ÌÉ≠Ïùò ÏÉÅÌíàÏù¥ ÌÜµÌï© Ï£ºÎ¨∏ÎêòÏóàÏäµÎãàÎã§.");
        }

        // --- 7. Search Logic ---
        function toggleSearch() {
            const isHidden = window.getComputedStyle(searchArea).display === 'none';
            if (isHidden) {
                searchArea.style.display = 'block';
                localInput.focus();
            } else {
                searchArea.style.display = 'none';
                localInput.value = '';
                handleLocalSearch(); 
            }
        }

        localInput.addEventListener('keyup', handleLocalSearch);

        function handleLocalSearch() {
            const query = localInput.value.trim();
            if (query !== searchQuery) {
                currentSearchLimit = INITIAL_LIMIT;
            }
            searchQuery = query;
            renderContent(); 
        }

        // --- 8. Global Search Modal ---
        function openGlobalSearch() {
            modalEl.classList.add('open');
            document.getElementById('modalSearchQuery').innerText = searchQuery || 'Ï†ÑÏ≤¥';
        }

        function closeGlobalSearch() {
            modalEl.classList.remove('open');
            selectedGlobalIds.clear();
        }

        function showToast(msg) {
            toastEl.innerText = msg;
            toastEl.classList.add('show');
            setTimeout(() => {
                toastEl.classList.remove('show');
            }, 3000);
        }

        function handleNavClick(type) {
            const navItems = document.querySelectorAll('.nav-item');
            navItems.forEach(item => item.classList.remove('active'));
            
            if (type === 'home') {
                navItems[0].classList.add('active');
                switchTab('list1'); 
            } else if (type === 'search') {
                navItems[1].classList.add('active');
                toggleSearch();
            } else if (type === 'check') {
                navItems[2].classList.add('active');
                switchTab('list1'); 
            } else if (type === 'kakao') {
                navItems[3].classList.add('active');
                alert('Ïπ¥Ïπ¥Ïò§ÌÜ° ÏÉÅÎã¥Ï∞ΩÏùÑ ÏóΩÎãàÎã§.');
            }
        }

        // --- Init ---
        updateOrderButton();
        renderContent();

    </script>
</body>
</html>
