<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ë¹ ë¥¸ ì£¼ë¬¸ ì‹œë®¬ë ˆì´ì…˜</title>
    <style>
        /* --- Reset & Base Styles --- */
        * { box-sizing: border-box; margin: 0; padding: 0; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif; -webkit-tap-highlight-color: transparent; }
        body { background-color: #f5f5f5; display: flex; justify-content: center; min-height: 100vh; color: #333; }
        
        /* --- Mobile Container Layout --- */
        .app-container {
            width: 100%; max-width: 480px; background-color: #fff; position: relative;
            box-shadow: 0 0 20px rgba(0,0,0,0.05); overflow: hidden; display: flex; flex-direction: column; height: 100vh;
        }

        /* --- Colors & Vars --- */
        :root { 
            --primary: #008f3e; 
            --primary-dark: #007a35;
            --gray-text: #666; 
            --border: #eef1f4; 
            --bg-gray: #f9f9f9; 
            --blue-btn: #eef6ff; 
            --blue-text: #2d70f3; 
            --red-point: #ff4b4b;
        }

        /* --- Icons (SVG) --- */
        .icon { width: 24px; height: 24px; fill: none; stroke: currentColor; stroke-width: 2; stroke-linecap: round; stroke-linejoin: round; }

        /* --- Header --- */
        header { height: 56px; padding: 0 16px; display: flex; justify-content: space-between; align-items: center; background: #fff; z-index: 10; }
        .header-title { font-size: 20px; font-weight: 800; color: var(--primary); letter-spacing: -0.5px; }
        .header-btn { background: none; border: none; padding: 8px; margin: -8px; cursor: pointer; color: #333; }
        
        /* NEW: Header Link Button Style */
        .header-link-btn {
            display: flex;
            align-items: center;
            background: none;
            border: none;
            padding: 8px;
            margin: -8px;
            cursor: pointer;
            color: #333;
            text-decoration: none; /* For anchor tag behavior */
        }
        .header-link-text {
            margin-left: 6px;
            font-size: 15px;
            font-weight: 700;
            color: #333;
        }

        /* --- Tab Bar Wrapper (Fixed Segment Layout) */
        .tab-nav-wrapper {
            display: flex;
            align-items: center;
            border-bottom: 1px solid var(--border);
            background: #fff;
            width: 100%;
            height: 48px; /* Fixed height */
        }

        /* Fixed Width Container for Tabs */
        .tab-fixed-container {
            flex: 1; /* Take up all remaining space */
            display: flex;
            height: 100%;
        }

        /* Equal Width Tabs */
        .tab { 
            flex: 1; /* Equal distribution 1/N */
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 13px; /* Slightly reduced for fit */
            color: #999; 
            cursor: pointer; 
            font-weight: 500; 
            transition: all 0.2s;
            position: relative;
            white-space: nowrap;
            letter-spacing: -0.5px; /* Tighten text */
            padding: 0 2px; /* Minimal padding */
        }
        
        /* Active Indicator */
        .tab.active { 
            color: var(--primary); 
            font-weight: 800; 
            /* Full width bottom border for active tab */
        }
        .tab.active::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 0;
            width: 100%;
            height: 3px;
            background-color: var(--primary);
        }

        /* Fixed Edit Button */
        .tab-fixed-btn { 
            width: 44px; /* Fixed width for button */
            height: 100%;
            display: flex; 
            align-items: center; 
            justify-content: center; 
            border-left: 1px solid var(--border); 
            color: #aaa; 
            background: #fff; 
            cursor: pointer;
            flex-shrink: 0; /* Prevent shrinking */
        }

        /* --- Sort Control (Inline Style) --- */
        .sort-control {
            display: flex; align-items: center; font-size: 13px; color: #888; font-weight: 400; margin-right: 8px;
        }
        .sort-option { cursor: pointer; }
        .sort-option.active { color: #333; font-weight: 700; }
        .sort-divider { color: #ddd; margin: 0 6px; font-size: 10px; }

        /* --- Search Area (Toggle) --- */
        .search-area { padding: 12px 16px; background: #fff; border-bottom: 1px solid var(--border); display: none; animation: slideDown 0.2s ease-out; }
        @keyframes slideDown { from { transform: translateY(-10px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
        
        .search-box-wrapper { display: flex; align-items: center; gap: 10px; }
        .search-input-box { flex: 1; display: flex; align-items: center; border: 2px solid var(--primary); border-radius: 8px; padding: 8px 12px; height: 44px; }
        .search-input-box input { flex: 1; border: none; outline: none; font-size: 16px; margin-left: 8px; }
        .search-cancel { font-size: 15px; color: #666; cursor: pointer; padding: 5px; white-space: nowrap; }

        /* --- Content Area --- */
        .content-scroll { flex: 1; overflow-y: auto; background: #fff; padding-bottom: 140px; /* nav(60) + footer(72) + buffer */ }
        
        /* Category Styles */
        .category-section { border-bottom: 8px solid #f5f5f5; }
        .category-section:last-child { border-bottom: none; }
        
        .category-header { 
            padding: 16px; font-size: 15px; color: #333; font-weight: 700; 
            border-bottom: 1px solid var(--border); background: #fff; 
            display: flex; justify-content: space-between; align-items: center;
            cursor: pointer; /* Restore pointer */
            user-select: none;
        }
        .category-header span { color: #888; font-weight: 400; margin-left: 4px; }
        
        /* Arrow Rotation Logic */
        .category-arrow { transition: transform 0.3s; color: #aaa; }
        .category-arrow { transform: rotate(0deg); } 
        .category-header.open .category-arrow { transform: rotate(180deg); }

        .category-header-right { display: flex; align-items: center; }

        .category-items { display: none; }
        .category-items.open { display: block; animation: expandList 0.3s ease-out; }
        
        @keyframes expandList {
            from { opacity: 0; transform: translateY(-5px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* --- Product List Item --- */
        .product-item { display: flex; padding: 16px; border-bottom: 1px solid var(--border); }
        
        .prod-img { width: 70px; height: 70px; background: #f0f0f0; border-radius: 8px; margin-right: 16px; display: flex; align-items: center; justify-content: center; font-size: 32px; flex-shrink: 0; position: relative; overflow: hidden;}
        .prod-img img { width: 100%; height: 100%; object-fit: cover; }
        
        .prod-info { flex: 1; display: flex; flex-direction: column; justify-content: center; min-width: 0; }
        .prod-name { font-size: 16px; font-weight: 600; margin-bottom: 6px; color: #222; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
        .prod-unit { font-size: 13px; color: #999; margin-bottom: 6px; }
        .prod-price { font-size: 16px; font-weight: 800; color: var(--primary); }
        .prod-tag { display: inline-block; font-size: 11px; color: #ff6b6b; border: 1px solid #ff6b6b; padding: 1px 4px; border-radius: 3px; margin-bottom: 4px; width: fit-content;}

        /* --- Quantity Control --- */
        .qty-control { display: flex; align-items: center; border: 1px solid #e0e0e0; border-radius: 6px; height: 36px; margin-left: 10px; background: #fff; overflow: hidden; }
        .qty-btn { width: 32px; height: 100%; border: none; background: #f8f9fa; cursor: pointer; display: flex; align-items: center; justify-content: center; color: #555; font-size: 18px; transition: background 0.1s; }
        .qty-btn:active { background: #e9ecef; }
        .qty-val { width: 36px; text-align: center; font-size: 15px; font-weight: 600; color: #333; }

        /* --- Search Section Headers --- */
        .search-section-header {
            padding: 12px 16px; background: #f0f2f5; color: #555; font-size: 14px; font-weight: 700; border-bottom: 1px solid #e0e0e0;
        }
        
        /* Load More Button Style */
        .search-more-btn {
            display: flex; justify-content: center; align-items: center; width: 100%; padding: 16px; 
            background: #fff; color: #555; border: none; border-bottom: 1px solid #f0f0f0;
            font-size: 14px; font-weight: 600; cursor: pointer; transition: background 0.2s;
        }
        .search-more-btn:active { background: #f9f9f9; }
        .search-more-btn::after {
            content: ''; display: inline-block; margin-left: 6px; width: 8px; height: 8px;
            border-right: 2px solid #aaa; border-bottom: 2px solid #aaa; transform: rotate(45deg); margin-top: -4px;
        }

        /* --- Toast Message --- */
        .toast-msg {
            position: fixed; bottom: 140px; left: 50%; transform: translateX(-50%);
            background: rgba(0,0,0,0.8); color: #fff; padding: 10px 20px; border-radius: 20px;
            font-size: 14px; z-index: 2000; opacity: 0; transition: opacity 0.3s; pointer-events: none;
        }
        .toast-msg.show { opacity: 1; }

        /* --- Footer (Order Bar) - Adjusted for Bottom Nav --- */
        .footer-bar {
            position: absolute; bottom: 60px; /* Above Bottom Nav */
            left: 0; right: 0; background: #fff; border-top: 1px solid #e0e0e0; 
            padding: 12px 16px; display: flex; align-items: center; height: 72px; z-index: 50; 
            box-shadow: 0 -4px 10px rgba(0,0,0,0.03);
        }
        .delivery-info { margin-right: auto; line-height: 1.3; }
        .delivery-label { font-size: 12px; color: #666; }
        .delivery-date { font-size: 15px; color: var(--blue-text); font-weight: 700; }
        
        .order-btn {
            background: #b0b8c1; color: #fff; border: none; padding: 0 24px; height: 48px; border-radius: 8px; 
            font-weight: 700; font-size: 16px; cursor: not-allowed; min-width: 200px; box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            transition: background 0.2s;
        }
        .order-btn.active { background: #50555c; cursor: pointer; } 

        /* --- Bottom Navigation Bar (Text Removed) --- */
        .bottom-nav {
            position: absolute; bottom: 0; left: 0; width: 100%; height: 60px;
            background: #fff; border-top: 1px solid #eee; display: flex;
            justify-content: space-around; align-items: center; z-index: 60;
        }
        .nav-item {
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            width: 100%; height: 100%; color: #999; cursor: pointer;
            -webkit-tap-highlight-color: transparent;
        }
        .nav-item.active { color: var(--primary); }
        .nav-item svg { width: 24px; height: 24px; stroke-width: 2; }
        /* Removed .nav-item span styles */
        
        /* Kakao Icon Color Override */
        .nav-item.kakao svg { fill: #3c1e1e; stroke: none; }
        .nav-item.kakao.active { color: #3c1e1e; }


        /* --- SPA Modal (Full Screen) --- */
        .modal-spa {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #f5f5f5; z-index: 2000;
            display: flex; flex-direction: column; transform: translateX(100%); transition: transform 0.3s cubic-bezier(0.16, 1, 0.3, 1);
        }
        .modal-spa.open { transform: translateX(0); }
        
        .modal-header { height: 56px; padding: 0 16px; background: #fff; display: flex; align-items: center; border-bottom: 1px solid #eee; }
        .modal-back-btn { background: none; border: none; padding: 8px; margin-left: -8px; margin-right: 8px; cursor: pointer; }
        .modal-title { font-size: 18px; font-weight: 700; flex: 1; }
        .modal-action { font-size: 14px; color: #666; font-weight: 500; cursor: pointer; }

        .modal-content { flex: 1; overflow-y: auto; padding-bottom: 80px; }
        
        .modal-item { background: #fff; padding: 16px; margin-bottom: 1px; display: flex; align-items: center; cursor: pointer; }
        .modal-item:active { background: #f9f9f9; }
        .modal-checkbox { 
            width: 24px; height: 24px; border: 2px solid #ddd; border-radius: 4px; margin-left: auto; 
            display: flex; align-items: center; justify-content: center; transition: all 0.2s;
        }
        .modal-checkbox.checked { background: var(--primary); border-color: var(--primary); }
        .modal-checkbox.checked::after { content: ''; width: 6px; height: 10px; border: solid white; border-width: 0 2px 2px 0; transform: rotate(45deg) translateY(-1px); }

        .modal-confirm-container {
            position: absolute; bottom: 30px; left: 0; right: 0; padding: 0 20px; text-align: center; pointer-events: none;
        }
        .modal-confirm-btn {
            background: var(--primary); color: #fff; border: none; padding: 16px; width: 100%; border-radius: 30px;
            font-size: 16px; font-weight: 700; box-shadow: 0 5px 15px rgba(0, 143, 62, 0.4); 
            cursor: pointer; pointer-events: auto; transform: translateY(100px); transition: transform 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }
        .modal-confirm-btn.visible { transform: translateY(0); }

        /* Empty State */
        .empty-state { text-align: center; padding: 60px 20px; color: #999; font-size: 15px; }

    </style>
</head>
<body>

    <div class="app-container">
        <!-- Main Header -->
        <header>
            <button class="header-link-btn" onclick="window.location.href='https://nhline.co.kr/'">
                <svg class="icon" viewBox="0 0 24 24"><path d="M3 12h18M3 6h18M3 18h18"></path></svg>
                <span class="header-link-text">NHë¼ì¸</span>
            </button>
            <div class="header-title">ì˜¤ë”ì¦ˆ</div>
            <div class="header-btn" style="font-size: 14px; font-weight: bold; color: #666;">OP</div>
        </header>

        <!-- Search Bar (Initially Hidden) -->
        <div class="search-area" id="searchArea">
            <div class="search-box-wrapper">
                <div class="search-input-box">
                    <svg class="icon" style="width:20px; height:20px; color:#aaa;" viewBox="0 0 24 24"><circle cx="11" cy="11" r="8"></circle><line x1="21" y1="21" x2="16.65" y2="16.65"></line></svg>
                    <input type="text" id="localSearchInput" placeholder="ìƒí’ˆëª… ê²€ìƒ‰ (ì˜ˆ: ë¬´)" autocomplete="off">
                </div>
                <div class="search-cancel" onclick="toggleSearch()">ì·¨ì†Œ</div>
            </div>
        </div>

        <!-- NEW Tab Bar Structure: FIXED SEGMENT LAYOUT -->
        <div class="tab-nav-wrapper">
            <div class="tab-fixed-container">
                <div class="tab" id="tab-special" onclick="switchTab('special')">ë‹¨ê³¨íŠ¹ê°€</div>
                <div class="tab active" id="tab-main" onclick="switchTab('main')">ì „ì²´</div>
                <div class="tab" id="tab-list1" onclick="switchTab('list1')">LIST 1</div>
                <div class="tab" id="tab-list2" onclick="switchTab('list2')">LIST 2</div>
                <div class="tab" id="tab-list3" onclick="switchTab('list3')">LIST 3</div>
            </div>
            
            <!-- Fixed Edit Button -->
            <div class="tab-fixed-btn" onclick="alert('í¸ì§‘/ì„¤ì • í™”ë©´ìœ¼ë¡œ ì´ë™í•©ë‹ˆë‹¤.')">
                <svg class="icon" style="width:18px; height:18px;" viewBox="0 0 24 24">
                    <line x1="4" y1="21" x2="4" y2="14"></line><line x1="4" y1="10" x2="4" y2="3"></line>
                    <line x1="12" y1="21" x2="12" y2="12"></line><line x1="12" y1="8" x2="12" y2="3"></line>
                    <line x1="20" y1="21" x2="20" y2="16"></line><line x1="20" y1="12" x2="20" y2="3"></line>
                    <line x1="1" y1="14" x2="7" y2="14"></line><line x1="9" y1="8" x2="15" y2="8"></line>
                    <line x1="17" y1="16" x2="23" y2="16"></line>
                </svg>
            </div>
        </div>

        <!-- Main Content Scroll Area -->
        <div class="content-scroll" id="scrollContainer">
            <div id="mainContentArea"></div>

            <div class="global-search-suggestion" id="globalSearchSuggestion">
                <div class="global-search-text">ì°¾ìœ¼ì‹œëŠ” ìƒí’ˆì´ ë¦¬ìŠ¤íŠ¸ì— ì—†ë‚˜ìš”?</div>
                <button class="global-search-btn" id="globalSearchBtn" onclick="openGlobalSearch()">
                    ì „ì²´ ìƒí’ˆì—ì„œ ê²€ìƒ‰í•˜ê¸°
                </button>
            </div>
        </div>

        <!-- Order Action Bar -->
        <div class="footer-bar">
            <div class="delivery-info">
                <div class="delivery-label">ë°°ì†¡ì˜ˆì •ì¼</div>
                <div class="delivery-date">2025-10-20 (ì›”)</div>
            </div>
            <button class="order-btn" id="mainOrderBtn" onclick="processOrder()">ì£¼ë¬¸í•  ìƒí’ˆì„ ë‹´ì•„ì£¼ì„¸ìš”</button>
        </div>

        <!-- Bottom Navigation Bar -->
        <nav class="bottom-nav">
            <div class="nav-item active" onclick="handleNavClick('home')">
                <svg viewBox="0 0 24 24" class="icon" fill="none" stroke="currentColor">
                    <path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"></path>
                    <polyline points="9 22 9 12 15 12 15 22"></polyline>
                </svg>
            </div>
            <div class="nav-item" onclick="handleNavClick('search')">
                <svg viewBox="0 0 24 24" class="icon" fill="none" stroke="currentColor">
                    <circle cx="11" cy="11" r="8"></circle>
                    <line x1="21" y1="21" x2="16.65" y2="16.65"></line>
                </svg>
            </div>
            <div class="nav-item" onclick="handleNavClick('check')">
                <svg viewBox="0 0 24 24" class="icon" fill="none" stroke="currentColor">
                    <polyline points="9 11 12 14 22 4"></polyline>
                    <path d="M21 12v7a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11"></path>
                </svg>
            </div>
            <div class="nav-item kakao" onclick="handleNavClick('kakao')">
                <svg viewBox="0 0 24 24" class="icon">
                    <path d="M12 3c-5.52 0-10 3.58-10 8 0 2.86 1.89 5.4 4.85 6.86-.21.78-.77 2.82-.88 3.23a.62.62 0 0 0 .89.72c.36-.26 3.65-2.48 4.26-2.91.29.04.59.06.88.06 5.52 0 10-3.58 10-8s-4.48-8-10-8z" fill="#3c1e1e"></path>
                </svg>
            </div>
        </nav>
        
        <!-- Toast Message -->
        <div id="toast" class="toast-msg"></div>
    </div>

    <!-- SPA Modal: Global Search -->
    <div class="modal-spa" id="globalSearchModal">
        <div class="modal-header">
            <button class="modal-back-btn" onclick="closeGlobalSearch()">
                <svg class="icon" viewBox="0 0 24 24"><polyline points="15 18 9 12 15 6"></polyline></svg>
            </button>
            <div class="modal-title"><span style="color:#ff4b4b" id="modalSearchQuery"></span> ê²€ìƒ‰ ê²°ê³¼</div>
            <div class="modal-action">ì •ì§€ìƒí’ˆë³´ê¸°</div>
        </div>
        
        <div class="modal-content" id="modalList">
            <!-- Modal Items -->
        </div>

        <div class="modal-confirm-container">
            <button class="modal-confirm-btn" id="modalConfirmBtn" onclick="confirmGlobalSelection()">
                ì„ íƒ ìƒí’ˆ ë¦¬ìŠ¤íŠ¸ì— ì¶”ê°€
            </button>
        </div>
    </div>

    <script>
        // --- 1. Data Mockup ---
        const categoryData = [
            {
                id: 'veg',
                title: 'ëŒ€ë¶„ë¥˜ ì±„ì†Œ/ê³¼ì¼',
                isOpen: true, 
                items: [
                    { id: 2, name: "ì–‘ë°°ì¶”(ëŒ€)42ë§(3ì…) BOX", unit: "BOX", price: 10900, img: "ğŸ¥¦", tag: null },
                    { id: 3, name: "ì–‘íŒŒ_ì™•20kgë§ BOX", unit: "BOX", price: 22000, img: "ğŸ§…", tag: null },
                    { id: 5, name: "ëŒ€íŒŒ/ (ë‹¨) EA", unit: "EA", price: 3200, img: "ğŸ‹", tag: null },
                ]
            },
            {
                id: 'food',
                title: 'ì‹í’ˆ,ìŒë£Œ',
                isOpen: true, 
                items: [
                    { id: 10, name: "ì˜¤ëšœê¸°_ì§„ë¼ë©´_ë§¤ìš´ë§› 30ì…", unit: "BOX", price: 24500, img: "ğŸœ", tag: null },
                    { id: 11, name: "ì½”ì¹´ì½œë¼_ì—…ì†Œìš© 1.25L", unit: "EA", price: 2100, img: "ğŸ¥¤", tag: "ì¸ê¸°" },
                ]
            },
            {
                id: 'sauce',
                title: 'ì–‘ë…,ì†ŒìŠ¤',
                isOpen: true, 
                items: [
                    { id: 20, name: "ëª½ê³ _ì§„ê°„ì¥_13L", unit: "CAN", price: 48000, img: "ğŸº", tag: null },
                    { id: 21, name: "CJ_í•´ì°¬ë“¤_ê³ ì¶”ì¥ 14kg", unit: "CAN", price: 52000, img: "ğŸŒ¶ï¸", tag: null },
                    { id: 22, name: "ë°±ì„¤_í•˜ì–€ì„¤íƒ• 15kg", unit: "åŒ…", price: 19800, img: "ğŸ§‚", tag: null },
                    { id: 23, name: "ì˜¤ëšœê¸°_ì˜›ë‚ ì°¸ê¸°ë¦„", unit: "CAN", price: 32000, img: "ğŸ§ˆ", tag: null },
                    { id: 24, name: "ë¯¸ì›_2kg", unit: "EA", price: 9500, img: "ğŸ§‚", tag: null },
                ]
            }
        ];

        // Special Event Products for 'ë‹¨ê³¨íŠ¹ê°€'
        const specialData = [
            { id: 201, name: "[í–‰ì‚¬] í–‡ ì–‘íŒŒ 15kg", unit: "ë§", price: 12000, img: "ğŸ§…", tag: "ì´ˆíŠ¹ê°€" },
            { id: 202, name: "[í–‰ì‚¬] ë‹¤ë°œë¬´ 1ë‹¨", unit: "ë‹¨", price: 4500, img: "ğŸ¥¬", tag: "í•œì •ìˆ˜ëŸ‰" },
            { id: 203, name: "[ì´ë²¤íŠ¸] ì‹ ë¼ë©´ 30ì…", unit: "BOX", price: 21000, img: "ğŸœ", tag: "íŠ¹ê°€" }
        ];

        // Mocking a larger database for simulation
        const globalDatabase = [
            { id: 101, name: "ë¬´ìš°_íŠ¹ë°•ìŠ¤_10ì… BOX", unit: "BOX", price: 22800, img: "ğŸ“¦", tag: "í–‰ì‚¬", targetCat: 'veg' },
            { id: 102, name: "ë¬´ìš°_ìƒë°•ìŠ¤ BOX", unit: "BOX", price: 17000, img: "ğŸ“¦", tag: null, targetCat: 'veg' },
            { id: 103, name: "ë¬´ìš°(ë‚±ê°œ)", unit: "EA", price: 2800, img: "ğŸ¥£", tag: null, targetCat: 'veg' },
            { id: 104, name: "ë¬´ìˆœì†Œ_60gíŒ© EA", unit: "EA", price: 500, img: "ğŸŒ±", tag: null, targetCat: 'veg' },
            { id: 105, name: "ì‚¶ì€ë¬´ì²­ì‹œë˜ê¸°_1kgX10 BOX", unit: "BOX", price: 27800, img: "ğŸ¥˜", tag: null, targetCat: 'veg' }
        ];

        // --- 2. State Management ---
        // MODIFIED: List 1, 2, 3 items pre-populated with quantity 0
        let carts = {
            'special': {}, 
            'main': {},
            // LIST 1: Veggies + Sauce (Qty 0)
            'list1': { 2: 0, 3: 0, 5: 0, 20: 0 }, 
            // LIST 2: Food + Special (Qty 0)
            'list2': { 10: 0, 11: 0, 203: 0, 21: 0 }, 
            // LIST 3: Sauce + Global (Qty 0)
            'list3': { 22: 0, 23: 0, 24: 0, 101: 0 } 
        };
        
        let selectedGlobalIds = new Set();
        let searchQuery = "";
        let currentTab = 'main'; // 'special', 'main', 'list1', 'list2', 'list3'
        let currentSort = 'category'; 
        
        const INITIAL_LIMIT = 3; 
        const LOAD_STEP = 3;
        let currentSearchLimit = INITIAL_LIMIT;

        // --- 3. DOM Elements ---
        const mainContentArea = document.getElementById('mainContentArea');
        const searchArea = document.getElementById('searchArea');
        const localInput = document.getElementById('localSearchInput');
        const suggestionBox = document.getElementById('globalSearchSuggestion');
        const modalEl = document.getElementById('globalSearchModal');
        const modalListEl = document.getElementById('modalList');
        const orderBtn = document.getElementById('mainOrderBtn');
        const scrollContainer = document.getElementById('scrollContainer');
        const toastEl = document.getElementById('toast');

        // Helper: Get Current Cart Key
        function getCurrentCartKey() {
            if (currentTab === 'special') return 'special'; // Special has its own cart
            if (currentTab === 'main') return 'main';
            return currentTab; // 'list1', 'list2', 'list3'
        }

        // --- 4. Content Rendering Logic ---
        
        function getSortControlHTML() {
            return `
                <div class="sort-control">
                    <span class="sort-option ${currentSort === 'category' ? 'active' : ''}" onclick="setSort(event, 'category')">ì¹´í…Œê³ ë¦¬ìˆœ</span>
                    <span class="sort-divider">|</span>
                    <span class="sort-option ${currentSort === 'newest' ? 'active' : ''}" onclick="setSort(event, 'newest')">ìµœì‹ ìˆœ</span>
                </div>
            `;
        }

        function setSort(e, mode) {
            e.stopPropagation();
            currentSort = mode;
            renderContent();
        }

        function renderContent() {
            mainContentArea.innerHTML = '';

            // 1. Search Mode Priority
            if (searchQuery) {
                renderSearchResults();
                return;
            }

            // 2. Tab Logic
            if (currentTab === 'special') {
                // RENDER SPECIAL TAB CONTENT
                const headerDiv = document.createElement('div');
                headerDiv.className = 'category-header';
                headerDiv.style.cursor = 'default';
                headerDiv.style.justifyContent = 'flex-end'; 
                headerDiv.style.borderBottom = '1px solid #eef1f4';
                headerDiv.innerHTML = getSortControlHTML();
                mainContentArea.appendChild(headerDiv);

                renderSpecialItems();

            } else if (currentTab === 'main') {
                // RENDER MAIN TAB CONTENT
                const headerDiv = document.createElement('div');
                headerDiv.className = 'category-header';
                headerDiv.style.cursor = 'default';
                headerDiv.style.justifyContent = 'flex-end'; 
                headerDiv.style.borderBottom = '1px solid #eef1f4';
                headerDiv.innerHTML = getSortControlHTML();
                mainContentArea.appendChild(headerDiv);

                if (currentSort === 'category') {
                    renderCategoryView();
                } else {
                    renderAllItemsFlat('newest'); 
                }
            } else if (['list1', 'list2', 'list3'].includes(currentTab)) {
                renderFlatCartView(currentTab);
            }
        }

        // Render function for Special Items
        function renderSpecialItems() {
            const container = document.createElement('div');
            // Reuse product creation logic. Data comes from specialData
            specialData.forEach(item => {
                container.appendChild(createProductElement(item));
            });
            mainContentArea.appendChild(container);
            suggestionBox.style.display = 'none';
        }

        function renderCategoryView() {
            categoryData.forEach(cat => {
                const section = document.createElement('div');
                section.className = 'category-section';
                
                const header = document.createElement('div');
                header.className = `category-header ${cat.isOpen ? 'open' : ''}`;
                header.onclick = () => toggleCategory(cat.id);
                
                let leftContent = `<div>${cat.title} <span>(${cat.items.length})</span></div>`;
                let rightContent = `<div class="category-header-right">
                    <svg class="icon category-arrow" viewBox="0 0 24 24"><polyline points="6 9 12 15 18 9"></polyline></svg>
                </div>`; 
                
                header.innerHTML = leftContent + rightContent;
                
                const itemContainer = document.createElement('div');
                itemContainer.className = `category-items ${cat.isOpen ? 'open' : ''}`;
                
                cat.items.forEach(item => {
                    itemContainer.appendChild(createProductElement(item));
                });

                section.appendChild(header);
                section.appendChild(itemContainer);
                mainContentArea.appendChild(section);
            });
            suggestionBox.style.display = 'none';
        }

        function renderAllItemsFlat(sortMode) {
            let allItems = [];
            categoryData.forEach(cat => allItems.push(...cat.items));
            
            if (sortMode === 'newest') {
                allItems.sort((a, b) => b.id - a.id);
            }

            const container = document.createElement('div');
            allItems.forEach(item => {
                container.appendChild(createProductElement(item));
            });
            
            mainContentArea.appendChild(container);
            suggestionBox.style.display = 'none';
        }

        function renderFlatCartView(listKey) {
            suggestionBox.style.display = 'none';

            let allItems = [];
            categoryData.forEach(cat => allItems.push(...cat.items));
            allItems.push(...globalDatabase); 
            allItems.push(...specialData); 

            const currentCart = carts[listKey] || {};
            const cartKeys = Object.keys(currentCart);

            // MODIFIED FILTERING: Include items if the ID exists as a key in the cart, regardless of quantity (0 or more)
            let cartItems = allItems.filter(item => cartKeys.includes(String(item.id)));

            if (cartItems.length === 0) {
                mainContentArea.innerHTML = `
                    <div class="empty-state">
                        <svg class="icon" style="width:48px; height:48px; margin-bottom:12px; color:#ccc;" viewBox="0 0 24 24"><path d="M6 2L3 6v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2V6l-3-4z"></path><line x1="3" y1="6" x2="21" y2="6"></line><path d="M16 10a4 4 0 0 1-8 0"></path></svg>
                        <br>ë¦¬ìŠ¤íŠ¸ì— ë‹´ê¸´ ìƒí’ˆì´ ì—†ìŠµë‹ˆë‹¤.
                    </div>
                `;
                return;
            }

            if (currentSort === 'newest') {
                cartItems.sort((a, b) => b.id - a.id);
            }

            const headerDiv = document.createElement('div');
            headerDiv.className = 'category-header inbox-header'; 
            headerDiv.style.borderBottom = '1px solid #eee';
            headerDiv.style.cursor = 'default';
            let listName = listKey === 'list1' ? 'LIST 1' : listKey === 'list2' ? 'LIST 2' : 'LIST 3';

            headerDiv.innerHTML = `
                <div>${listName} ìƒí’ˆ <span>(${cartItems.length})</span></div>
                <div class="category-header-right">
                    ${getSortControlHTML()}
                </div>
            `;
            mainContentArea.appendChild(headerDiv);

            cartItems.forEach(item => {
                mainContentArea.appendChild(createProductElement(item));
            });
        }

        // --- Search View ---
        function renderSearchResults() {
            let localItems = [];
            categoryData.forEach(cat => {
                localItems = [...localItems, ...cat.items];
            });
            // Add Special Data to local items for search
            localItems = [...localItems, ...specialData];

            const localResults = localItems.filter(p => p.name.includes(searchQuery));
            const globalResults = globalDatabase.filter(p => p.name.includes(searchQuery));
            
            const section1 = document.createElement('div');
            section1.innerHTML = `<div class="search-section-header">ë‹´ì•„ë‘” ìƒí’ˆ (${localResults.length})</div>`;
            if (localResults.length === 0) {
                section1.innerHTML += `<div style="padding:20px; text-align:center; color:#999; font-size:14px;">ë‚´ ë¦¬ìŠ¤íŠ¸ì— ê²€ìƒ‰ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤.</div>`;
            } else {
                localResults.forEach(item => {
                    section1.appendChild(createProductElement(item));
                });
            }
            mainContentArea.appendChild(section1);
            
            const section2 = document.createElement('div');
            section2.innerHTML = `<div class="search-section-header">ì „ì²´ ìƒí’ˆ ê²€ìƒ‰ ê²°ê³¼ (${globalResults.length})</div>`;
            
            if (globalResults.length === 0) {
                section2.innerHTML += `<div style="padding:20px; text-align:center; color:#999; font-size:14px;">ê²€ìƒ‰ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤.</div>`;
            } else {
                const displayItems = globalResults.slice(0, currentSearchLimit);
                displayItems.forEach(item => {
                    section2.appendChild(createProductElement(item));
                });
                
                if (globalResults.length > currentSearchLimit) {
                    const moreBtn = document.createElement('button');
                    moreBtn.className = 'search-more-btn';
                    moreBtn.innerHTML = `ê²€ìƒ‰ ê²°ê³¼ ë”ë³´ê¸°`;
                    moreBtn.onclick = () => {
                        currentSearchLimit += LOAD_STEP;
                        renderContent(); 
                    };
                    section2.appendChild(moreBtn);
                }
            }
            mainContentArea.appendChild(section2);

            suggestionBox.style.display = 'none';
        }

        // Helper: Create Product Row
        function createProductElement(item) {
            const currentCart = carts[getCurrentCartKey()] || {};
            const qty = currentCart[item.id] || 0;
            
            const div = document.createElement('div');
            div.className = 'product-item';
            div.innerHTML = `
                <div class="prod-img">${item.img}</div>
                <div class="prod-info">
                    ${item.tag ? `<div class="prod-tag">${item.tag}</div>` : ''}
                    <div class="prod-name">${item.name}</div>
                    <div class="prod-unit">${item.unit}</div>
                    <div class="prod-price">${item.price.toLocaleString()}ì›</div>
                </div>
                <div class="qty-control">
                    <button class="qty-btn" onclick="updateQty(${item.id}, -1)">-</button>
                    <div class="qty-val" id="qty-${item.id}">${qty}</div>
                    <button class="qty-btn" onclick="updateQty(${item.id}, 1)">+</button>
                </div>
            `;
            return div;
        }

        function toggleCategory(catId) {
            const cat = categoryData.find(c => c.id === catId);
            if(cat) {
                cat.isOpen = !cat.isOpen;
                renderContent();
            }
        }

        // --- 5. Tab Logic ---
        function switchTab(tabName) {
            currentTab = tabName;
            
            const tabElements = {
                special: document.getElementById('tab-special'),
                main: document.getElementById('tab-main'),
                list1: document.getElementById('tab-list1'),
                list2: document.getElementById('tab-list2'),
                list3: document.getElementById('tab-list3')
            };

            Object.values(tabElements).forEach(el => {
                if(el) el.classList.remove('active');
            });

            if (tabElements[tabName]) {
                tabElements[tabName].classList.add('active');
            }

            if(searchQuery) {
                searchQuery = "";
                localInput.value = "";
                searchArea.style.display = 'none';
            }

            scrollContainer.scrollTop = 0;
            
            // Re-render and update footer for the new tab's cart
            renderContent();
            updateOrderButton();
        }

        // --- 6. Interaction Logic ---

        function updateQty(id, delta) {
            const cartKey = getCurrentCartKey();
            if(!carts[cartKey]) carts[cartKey] = {};
            
            if (!carts[cartKey][id]) carts[cartKey][id] = 0;
            
            carts[cartKey][id] += delta;
            if(carts[cartKey][id] < 0) carts[cartKey][id] = 0;

            const qtyEls = document.querySelectorAll(`#qty-${id}`);
            qtyEls.forEach(el => el.innerText = carts[cartKey][id]);

            updateOrderButton();
        }

        function updateOrderButton() {
            let totalCount = 0;
            let totalPrice = 0;
            
            // Collect ALL product info to look up prices
            let allItems = [];
            categoryData.forEach(cat => allItems.push(...cat.items));
            allItems = [...allItems, ...globalDatabase, ...specialData];
            
            // Sum up quantities from ALL carts (tabs)
            Object.values(carts).forEach(cart => {
                Object.keys(cart).forEach(key => {
                    const pid = parseInt(key);
                    const qty = cart[pid];
                    if(qty > 0) {
                        const product = allItems.find(p => p.id === pid);
                        if(product) {
                            totalCount += qty;
                            totalPrice += product.price * qty;
                        }
                    }
                });
            });

            if (totalCount > 0) {
                orderBtn.classList.add('active');
                orderBtn.innerHTML = `ì´ <span style="color:#fff">${totalCount}</span>ê°œ <span style="color:#fff">${totalPrice.toLocaleString()}ì›</span> ì£¼ë¬¸í•˜ê¸°`;
            } else {
                orderBtn.classList.remove('active');
                orderBtn.innerText = 'ì£¼ë¬¸í•  ìƒí’ˆì„ ë‹´ì•„ì£¼ì„¸ìš”';
            }
        }

        function processOrder() {
            if (!orderBtn.classList.contains('active')) return;
            
            // Clear ALL Carts since order is global
            Object.keys(carts).forEach(key => {
                carts[key] = {};
            });
            
            // Update UI
            renderContent(); 
            updateOrderButton();
            
            showToast("ëª¨ë“  íƒ­ì˜ ìƒí’ˆì´ í†µí•© ì£¼ë¬¸ë˜ì—ˆìŠµë‹ˆë‹¤.");
        }

        // --- 7. Search Logic ---
        function toggleSearch() {
            const isHidden = window.getComputedStyle(searchArea).display === 'none';
            if (isHidden) {
                searchArea.style.display = 'block';
                localInput.focus();
            } else {
                searchArea.style.display = 'none';
                localInput.value = '';
                handleLocalSearch(); 
            }
        }

        localInput.addEventListener('keyup', handleLocalSearch);

        function handleLocalSearch() {
            const query = localInput.value.trim();
            if (query !== searchQuery) {
                currentSearchLimit = INITIAL_LIMIT;
            }
            searchQuery = query;
            renderContent(); 
        }

        // --- 8. Global Search Modal ---
        function openGlobalSearch() {
            modalEl.classList.add('open');
            document.getElementById('modalSearchQuery').innerText = searchQuery || 'ì „ì²´';
        }

        function closeGlobalSearch() {
            modalEl.classList.remove('open');
            selectedGlobalIds.clear();
        }

        function showToast(msg) {
            toastEl.innerText = msg;
            toastEl.classList.add('show');
            setTimeout(() => {
                toastEl.classList.remove('show');
            }, 3000);
        }

        function handleNavClick(type) {
            const navItems = document.querySelectorAll('.nav-item');
            navItems.forEach(item => item.classList.remove('active'));
            
            if (type === 'home') {
                navItems[0].classList.add('active');
                switchTab('main');
            } else if (type === 'search') {
                navItems[1].classList.add('active');
                toggleSearch();
            } else if (type === 'check') {
                navItems[2].classList.add('active');
                switchTab('list1');
            } else if (type === 'kakao') {
                navItems[3].classList.add('active');
                alert('ì¹´ì¹´ì˜¤í†¡ ìƒë‹´ì°½ì„ ì—½ë‹ˆë‹¤.');
            }
        }

        // --- Init ---
        updateOrderButton();
        renderContent();

    </script>
</body>
</html>
