<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>오더즈 마케팅 링크 관리자 Ver 3.0</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@300;400;500;700&display=swap');
        body { font-family: 'Noto Sans KR', sans-serif; background-color: #f4f7fa; color: #334155; }
        
        /* 입력폼 테이블 */
        .tbl_frm { border-collapse: collapse; width: 100%; }
        .tbl_frm th { 
            background-color: #f8fafc; 
            padding: 18px 20px; 
            text-align: left; 
            font-weight: 600; 
            border-bottom: 1px solid #e2e8f0; 
            color: #475569; 
            width: 170px; 
            border-right: 1px solid #f1f5f9; 
            vertical-align: top; 
        }
        .tbl_frm td { padding: 18px 20px; border-bottom: 1px solid #e2e8f0; background-color: #fff; vertical-align: top; }

        /* 목록 테이블 */
        .tbl_head_container { background-color: #fff; border-radius: 8px; box-shadow: 0 1px 3px rgba(0,0,0,0.05); overflow: hidden; border: 1px solid #e2e8f0; }
        .tbl_head { border-collapse: collapse; width: 100%; table-layout: fixed; }
        .tbl_head th { 
            background-color: #f8fafc; 
            padding: 14px 10px; 
            font-weight: 700; 
            font-size: 12px; 
            border-bottom: 2px solid #edf2f7; 
            color: #64748b; 
            text-align: left; 
            vertical-align: middle; 
        }
        .tbl_head td { padding: 14px 10px; border-bottom: 1px solid #f1f5f9; font-size: 13px; color: #334155; vertical-align: middle; }
        
        /* 상태 뱃지 */
        .badge { padding: 2px 6px; border-radius: 4px; font-size: 10px; font-weight: 800; display: inline-block; min-width: 52px; text-align: center; }
        .badge-running { background-color: #e0f2fe; color: #0369a1; border: 1px solid #bae6fd; }
        .badge-waiting { background-color: #fef3c7; color: #92400e; border: 1px solid #fde68a; }
        .badge-stopped { background-color: #f1f5f9; color: #64748b; border: 1px solid #e2e8f0; }

        /* 토글 스위치 */
        .toggle-checkbox:checked { right: 0; border-color: #3b82f6; }
        .toggle-checkbox:checked + .toggle-label { background-color: #3b82f6; }

        /* 날짜 입력 */
        .list-date-input { 
            border: 1px solid transparent; 
            border-radius: 4px; 
            padding: 4px 6px; 
            font-size: 11px; 
            font-family: 'JetBrains Mono', monospace; 
            color: #64748b; 
            width: 105px;
            outline: none;
            background-color: transparent;
            cursor: pointer;
            text-align: center;
        }

        /* 필수 항목 강조 */
        .input-required { background-color: #eff6ff !important; border-color: #bfdbfe !important; }

        /* 미리보기 박스 */
        .step4-box { background-color: #f8fafc; border: 1px solid #e2e8f0; border-radius: 8px; padding: 16px; }
        .result-box {
            background-color: #475569;
            border-radius: 6px;
            padding: 14px;
            color: #ffffff;
            font-family: 'JetBrains Mono', monospace;
            font-size: 12px;
            line-height: 1.6;
            word-break: break-all;
            box-shadow: inset 0 2px 4px rgba(0,0,0,0.1);
        }
    </style>
</head>
<body>

    <header class="bg-white border-b border-slate-200 px-8 py-4 mb-6 shadow-sm sticky top-0 z-50">
        <div class="flex justify-between items-center max-w-7xl mx-auto w-full">
            <h1 class="text-xl font-bold text-slate-800"><i class="fas fa-link text-blue-600 mr-2"></i>마케팅 링크 빌더</h1>
            <div class="text-right">
                <span class="text-xs bg-slate-800 text-white px-2 py-1 rounded font-bold uppercase tracking-wider">Ver 3.0</span>
            </div>
        </div>
    </header>

    <div class="max-w-7xl mx-auto px-6 pb-20">

        <!-- 링크 생성 영역 -->
        <section class="mb-10">
            <div class="flex items-center gap-2 mb-3 border-l-4 border-blue-600 pl-3">
                <h2 class="text-base font-bold text-slate-700">신규 캠페인 생성</h2>
            </div>
            
            <div class="bg-white border border-slate-300 rounded-sm shadow-sm overflow-hidden">
                <table class="tbl_frm">
                    <tbody>
                        <!-- STEP 1 -->
                        <tr>
                            <th>
                                <div class="flex flex-col gap-1">
                                    <span class="bg-blue-600 text-white w-5 h-5 flex items-center justify-center rounded-full text-[10px] mb-1">1</span>
                                    <span>캠페인 정보 <span class="text-red-500">*</span></span>
                                </div>
                            </th>
                            <td colspan="3">
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                                    <div>
                                        <label class="block text-xs font-bold text-blue-800 mb-1.5 uppercase">캠페인 명 <span class="text-red-500">*</span></label>
                                        <input type="text" id="inputMemo" class="input-required w-full border px-3 py-2.5 rounded focus:outline-none text-sm font-bold text-slate-700 transition" placeholder="예: 26년 설날 감사 이벤트" oninput="updatePreview()">
                                    </div>
                                    <div>
                                        <div class="flex justify-between items-center mb-1.5">
                                            <label class="block text-xs font-bold text-slate-600 uppercase">담당 유통사 (yt_code)</label>
                                            <span class="text-[10px] text-slate-400 bg-slate-50 px-2 py-0.5 rounded border border-slate-200 leading-none">미입력 시 '본사'</span>
                                        </div>
                                        <input type="text" id="inputYt" class="w-full border border-slate-300 bg-white px-3 py-2.5 rounded focus:border-blue-500 focus:outline-none text-sm transition" placeholder="예: ABC001" oninput="updatePreview()">
                                    </div>
                                </div>
                            </td>
                        </tr>

                        <!-- STEP 2 -->
                        <tr>
                            <th>
                                <div class="flex flex-col gap-1">
                                    <span class="bg-slate-500 text-white w-5 h-5 flex items-center justify-center rounded-full text-[10px] mb-1">2</span>
                                    <span>연결 설정 <span class="text-red-500">*</span></span>
                                </div>
                            </th>
                            <td colspan="3">
                                <div class="flex flex-col gap-4">
                                    <div>
                                        <label class="block text-xs font-bold text-slate-600 mb-1 uppercase">광고/홍보 채널 <span class="text-blue-600 font-normal ml-1">(GA4 자동매핑)</span></label>
                                        <select id="inputSrc" class="input-required w-full md:w-1/2 border px-2 py-2 rounded focus:outline-none text-sm font-bold text-slate-700 transition" onchange="updatePreview()">
                                            <option value="referral" data-source="homepage" data-medium="referral">기본 (웹사이트/블로그)</option>
                                            <optgroup label="광고 (Paid)">
                                                <option value="paid_search" data-source="naver" data-medium="cpc">네이버 파워링크 (cpc)</option>
                                                <option value="paid_social" data-source="instagram" data-medium="paidsocial">인스타그램 광고</option>
                                            </optgroup>
                                        </select>
                                    </div>
                                    <div>
                                        <label class="block text-xs font-bold text-slate-700 mb-1 uppercase">랜딩페이지 (원본 URL) <span class="text-red-500">*</span></label>
                                        <input type="text" id="inputBaseUrl" class="input-required w-full border px-3 py-2.5 rounded text-slate-700 focus:outline-none shadow-sm font-medium transition" placeholder="https://orderz.kr/member/join.php" oninput="updatePreview()">
                                    </div>
                                </div>
                            </td>
                        </tr>

                        <!-- STEP 3 (단일 목적지 원칙) -->
                        <tr class="border-t border-slate-200">
                            <th>
                                <div class="flex flex-col gap-1">
                                    <span class="bg-slate-400 text-white w-5 h-5 flex items-center justify-center rounded-full text-[10px] mb-1">3</span>
                                    <span>회원가입 후 이동</span>
                                </div>
                            </th>
                            <td colspan="3">
                                <div class="md:col-span-2">
                                    <label class="block text-xs font-bold text-slate-700 mb-1 uppercase">이동 목적지 (Next URL)</label>
                                    <input type="text" id="inputNext" class="w-full border border-slate-300 bg-white px-3 py-2.5 rounded text-slate-600 focus:border-blue-500 focus:outline-none text-sm transition" placeholder="/event/coupon.php" oninput="updatePreview()">
                                    <p class="text-[10px] text-red-500 mt-2 font-bold italic"><i class="fas fa-shield-alt mr-1"></i> 보안: https://orderz.kr 내부 경로(/)만 입력하세요.</p>
                                </div>
                            </td>
                        </tr>

                        <!-- STEP 4 -->
                        <tr class="bg-blue-50/30 border-t border-blue-200">
                            <th>
                                <div class="flex flex-col gap-1">
                                    <span class="bg-blue-600 text-white w-5 h-5 flex items-center justify-center rounded-full text-[10px] mb-1">4</span>
                                    <span>링크 생성 <span class="text-red-500">*</span></span>
                                </div>
                            </th>
                            <td colspan="3">
                                <div class="step4-box mb-4 shadow-sm">
                                    <div class="flex items-center gap-2 mb-3">
                                        <span class="text-[10px] bg-slate-500 text-white px-2 py-0.5 rounded font-bold uppercase tracking-widest">1. 조합 결과 (Long URL)</span>
                                        <span class="text-[10px] text-slate-400 italic font-medium">* 설정값이 자동 적용된 결과 주소입니다.</span>
                                    </div>
                                    <div id="previewUrl" class="result-box select-all">
                                        https://orderz.kr/member/join.php?utm_source=homepage&utm_medium=referral
                                    </div>
                                </div>

                                <div class="step4-box border-blue-100 shadow-sm">
                                    <div class="flex items-center gap-2 mb-3">
                                        <span class="text-[10px] bg-blue-600 text-white px-2 py-0.5 rounded font-bold uppercase tracking-widest">2. 단축 코드 (Short Code)</span>
                                        <span class="text-[10px] text-blue-600 font-normal italic font-medium">*(영문, 숫자, _만 가능) 예: summer_sale_2026_01</span>
                                    </div>
                                    <div class="flex items-center gap-3">
                                        <div class="flex items-center flex-1 max-w-[450px]">
                                            <span class="inline-flex items-center px-3 h-11 rounded-l-lg border border-r-0 border-slate-300 bg-white text-slate-500 text-sm font-mono font-bold">orderz.kr/l/</span>
                                            <input type="text" id="inputCode" class="input-required flex-1 h-11 border px-3 rounded-r-lg focus:outline-none font-bold text-lg text-slate-800 shadow-sm transition" placeholder="sale_20260130" oninput="updatePreview()">
                                        </div>
                                        <button onclick="createLink()" class="px-10 h-11 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition text-sm font-bold flex items-center justify-center gap-2 whitespace-nowrap shadow-md transform active:scale-95">
                                            <i class="fas fa-link"></i> 단축 링크 생성
                                        </button>
                                    </div>
                                </div>
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </section>

        <!-- 관리 목록 -->
        <section>
            <div class="flex justify-between items-start mb-4 px-1">
                <div class="flex flex-col gap-1.5">
                    <h2 class="text-base font-bold text-slate-700 border-l-4 border-slate-600 pl-3">생성 목록</h2>
                    <p class="text-[11px] text-slate-500 ml-4 font-medium tracking-tight">※ 수동 전환 정책: 동일 코드 활성화 시 기존 링크를 먼저 꺼야 합니다.</p>
                </div>
                <div class="flex flex-col items-end gap-2">
                    <p class="text-[10px] text-blue-500 font-semibold italic">※ 쉼표(,)를 사용하여 캠페인명, 단축코드, 유통사, 채널을 다중 검색할 수 있습니다.</p>
                    <div class="relative">
                        <i class="fas fa-search absolute left-3 top-1/2 -translate-y-1/2 text-slate-400 text-xs"></i>
                        <input type="text" id="searchInput" placeholder="검색어 입력 (예: 여름, OFF001)" class="border border-slate-300 pl-9 pr-4 py-2.5 text-xs rounded-lg w-[400px] outline-none focus:border-blue-500 transition shadow-sm bg-white font-medium" onkeyup="filterList()">
                    </div>
                </div>
            </div>

            <div class="tbl_head_container">
                <table class="tbl_head">
                    <thead>
                        <tr>
                            <th style="width: 85px;" class="text-center">현재 상태</th>
                            <th style="width: 75px;" class="text-center">ON/OFF</th>
                            <th style="width: 22%;">캠페인 정보 / 유통사</th>
                            <th style="width: 260px;" class="text-center">운영 기간 (시작 ~ 종료)</th>
                            <th style="width: 140px;" class="text-center">성과(Hits) / 최근유입</th>
                            <th style="width: 30%;">연결 링크 정보</th>
                        </tr>
                    </thead>
                    <tbody id="linkListBody"></tbody>
                </table>
            </div>
        </section>
    </div>

    <script>
        const TODAY = "2026-01-30";
        let linkData = [
            { id: 104, code: "feb_event", full_url: "https://orderz.kr/join?utm_campaign=feb_event", memo: "2월 설날 감사 이벤트", yt: "-", active: true, hits: 0, last_hit_at: null, channel: "messaging", start_date: "2026-02-01", end_date: "2026-02-28" },
            { id: 103, code: "jan_sale", full_url: "https://orderz.kr/join?utm_campaign=jan_sale", memo: "1월 시즌오프 세일", yt: "OFF001", active: true, hits: 1450, last_hit_at: "2026-01-30 10:20:11", channel: "paid_social", start_date: "2026-01-01", end_date: "2026-02-15" }
        ];

        const DOM = {
            inputBaseUrl: document.getElementById('inputBaseUrl'),
            inputSrc: document.getElementById('inputSrc'),
            inputMemo: document.getElementById('inputMemo'),
            inputYt: document.getElementById('inputYt'),
            inputCode: document.getElementById('inputCode'),
            inputNext: document.getElementById('inputNext'),
            listBody: document.getElementById('linkListBody'),
            previewUrl: document.getElementById('previewUrl')
        };

        // 정책 수정 1: 단축 URL 조합 시 next 파라미터만 사용 (fallback 제거)
        function updatePreview() {
            const baseUrl = DOM.inputBaseUrl.value.trim() || 'https://orderz.kr/member/join.php';
            const campaignKey = DOM.inputCode.value.trim();
            const ytCode = DOM.inputYt.value.trim();
            const next = DOM.inputNext.value.trim();
            const selectedOption = DOM.inputSrc.options[DOM.inputSrc.selectedIndex];
            
            let params = [];
            if (selectedOption.dataset.source) params.push(`utm_source=${selectedOption.dataset.source}`);
            if (selectedOption.dataset.medium) params.push(`utm_medium=${selectedOption.dataset.medium}`);
            if (campaignKey) params.push(`utm_campaign=${campaignKey}`);
            if (ytCode) params.push(`yt_code=${encodeURIComponent(ytCode)}`);
            if (next) params.push(`next=${encodeURIComponent(next)}`);

            const separator = baseUrl.includes('?') ? '&' : '?';
            const finalUrl = params.length > 0 ? `${baseUrl}${separator}${params.join('&')}` : baseUrl;
            DOM.previewUrl.textContent = finalUrl;
            return finalUrl;
        }

        // 정책 수정 3: 날짜 미설정 시 상시 운영(제한 없음) 판별 로직 적용
        function getStatus(item) {
            if (!item.active) return { label: '정지중', class: 'badge-stopped' };
            if (item.start_date && TODAY < item.start_date) return { label: '대기중', class: 'badge-waiting' };
            if (item.end_date && TODAY > item.end_date) return { label: '정지중', class: 'badge-stopped' };
            return { label: '운영중', class: 'badge-running' };
        }

        function renderList(data = linkData) {
            DOM.listBody.innerHTML = "";
            const sortedData = [...data].sort((a, b) => b.id - a.id);

            sortedData.forEach(item => {
                const statusInfo = getStatus(item);
                const tr = document.createElement('tr');
                tr.className = item.active ? 'hover:bg-slate-50 transition' : 'bg-slate-50 opacity-70 grayscale-[0.3]';
                tr.innerHTML = `
                    <td class="text-center"><span class="badge ${statusInfo.class}">${statusInfo.label}</span></td>
                    <td class="text-center relative">
                        <div class="relative inline-block w-8 align-middle select-none">
                            <input type="checkbox" id="toggle-${item.id}" class="toggle-checkbox absolute block w-4 h-4 rounded-full bg-white border-2 appearance-none cursor-pointer border-slate-300 transition-all duration-300 ease-in-out" ${item.active ? 'checked' : ''} onchange="toggleActive(${item.id})"/>
                            <label for="toggle-${item.id}" class="toggle-label block overflow-hidden h-4 rounded-full bg-slate-300 cursor-pointer transition-colors duration-300 ease-in-out"></label>
                        </div>
                    </td>
                    <td>
                        <div class="font-bold text-slate-800 text-sm truncate" title="${item.memo}">${item.memo}</div>
                        <div class="text-[11px] text-slate-400">유통사: ${item.yt === '-' ? '본사직영' : item.yt}</div>
                    </td>
                    <td class="text-center">
                        <div class="flex items-center justify-center gap-1.5">
                            <input type="date" class="list-date-input" value="${item.start_date || ''}" onchange="updateDate(${item.id}, 'start', this.value)">
                            <span class="text-slate-300 font-bold font-mono">~</span>
                            <input type="date" class="list-date-input" value="${item.end_date || ''}" onchange="updateDate(${item.id}, 'end', this.value)">
                        </div>
                    </td>
                    <td class="text-center">
                        <div class="text-sm font-mono font-bold text-slate-700">${item.hits.toLocaleString()}</div>
                        <div class="text-[9px] text-slate-400">${item.last_hit_at ? item.last_hit_at : '-'}</div>
                    </td>
                    <td class="bg-slate-50/40">
                        <div class="text-[10px] text-slate-400 truncate opacity-60 font-mono mb-1">${item.full_url}</div>
                        <div class="flex items-center justify-between">
                            <span class="text-blue-600 font-bold text-[14px] font-mono cursor-pointer hover:underline" onclick="copyCode('${item.code}')">orderz.kr/l/${item.code}</span>
                        </div>
                    </td>
                `;
                DOM.listBody.append(tr);
            });
        }

        function createLink() {
            const memo = DOM.inputMemo.value.trim();
            const code = DOM.inputCode.value.trim();
            const baseUrl = DOM.inputBaseUrl.value.trim();
            const next = DOM.inputNext.value.trim();
            if (!memo || !code || !baseUrl) return alert("필수 항목을 입력해주세요.");
            if (next && !next.startsWith('/')) return alert("보안: 목적지 경로는 /로 시작해야 합니다.");
            
            linkData.push({ 
                id: Date.now(), code, full_url: updatePreview(), 
                memo, yt: DOM.inputYt.value.trim() || '-', 
                active: false, hits: 0, last_hit_at: null, 
                channel: DOM.inputSrc.value, start_date: null, end_date: null 
            });
            renderList();
            alert("단축 링크가 생성되었습니다. 목록에서 활성화해 주세요.");
            DOM.inputMemo.value = DOM.inputYt.value = DOM.inputCode.value = DOM.inputNext.value = "";
            updatePreview();
        }

        // 정책 수정 2: 바톤 터치 대신 '수동 전환(거부 및 안내)' 정책 적용
        function toggleActive(id) {
            const target = linkData.find(l => l.id === id);
            if (!target) return;
            
            // 켜려고 시도할 때 이미 동일 코드가 운영 중이면 차단
            if (!target.active && linkData.find(l => l.code === target.code && l.active && l.id !== id)) {
                alert("이미 활성화된 동일 코드가 존재합니다. 기존 활성 링크를 먼저 정지(OFF) 해주세요.");
                renderList(); 
                return;
            }
            
            target.active = !target.active;
            renderList();
        }

        function copyCode(code) {
            const text = `https://orderz.kr/l/${code}`;
            const t = document.createElement("textarea"); document.body.appendChild(t); t.value = text; t.select(); document.execCommand('copy'); document.body.removeChild(t);
            alert(`복사되었습니다: ${text}`);
        }

        function updateDate(id, type, value) {
            const item = linkData.find(l => l.id === id);
            if (!item) return;
            if (type === 'start') item.start_date = value;
            else item.end_date = value;
            renderList();
        }

        function filterList() {
            const kw = document.getElementById('searchInput').value.toLowerCase();
            if (!kw) { renderList(linkData); return; }
            const keywords = kw.split(',').map(k => k.trim()).filter(k => k);
            const filtered = linkData.filter(l => keywords.some(k => 
                l.memo.toLowerCase().includes(k) || l.code.toLowerCase().includes(k) || l.yt.toLowerCase().includes(k) || l.channel.toLowerCase().includes(k)
            ));
            renderList(filtered);
        }

        updatePreview();
        renderList();
    </script>
</body>
</html>
