<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>오더즈 마케팅 링크 관리자 (개발 명세용 프로토타입)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@300;400;500;700&display=swap');
        body { font-family: 'Noto Sans KR', sans-serif; background-color: #f4f7fa; color: #334155; }
        
        /* [테이블 공통 스타일] */
        .tbl_frm { border-collapse: collapse; width: 100%; }
        .tbl_frm th { 
            background-color: #f8fafc; 
            padding: 18px 20px; 
            text-align: left; 
            font-weight: 600; 
            border-bottom: 1px solid #e2e8f0; 
            color: #475569; 
            width: 170px; 
            border-right: 1px solid #f1f5f9; 
            vertical-align: top; 
        }
        .tbl_frm td { padding: 18px 20px; border-bottom: 1px solid #e2e8f0; background-color: #fff; vertical-align: top; }

        .tbl_head_container { background-color: #fff; border-radius: 8px; box-shadow: 0 1px 3px rgba(0,0,0,0.05); overflow: hidden; border: 1px solid #e2e8f0; }
        .tbl_head { border-collapse: collapse; width: 100%; table-layout: fixed; }
        .tbl_head th { 
            background-color: #f8fafc; 
            padding: 14px 10px; 
            font-weight: 700; 
            font-size: 12px; 
            border-bottom: 2px solid #edf2f7; 
            color: #64748b; 
            text-align: left; 
            vertical-align: middle; 
        }
        .tbl_head td { padding: 14px 10px; border-bottom: 1px solid #f1f5f9; font-size: 13px; color: #334155; vertical-align: middle; }
        
        /* [상태 배지 스타일] */
        .badge { padding: 2px 0; border-radius: 4px; font-size: 10px; font-weight: 800; display: block; width: 60px; text-align: center; margin-bottom: 2px; }
        .badge-running { background-color: #e0f2fe; color: #0369a1; border: 1px solid #bae6fd; } /* 운영중 */
        .badge-waiting { background-color: #fff7ed; color: #c2410c; border: 1px solid #fed7aa; } /* 예약중 */
        .badge-stopped { background-color: #f1f5f9; color: #64748b; border: 1px solid #e2e8f0; } /* 정지중 */
        .badge-expired { background-color: #fee2e2; color: #991b1b; border: 1px solid #fecaca; } /* 만료됨 */

        /* [토글 스위치] */
        .toggle-checkbox:checked { right: 0; border-color: #3b82f6; }
        .toggle-checkbox:checked + .toggle-label { background-color: #3b82f6; }

        /* [필수 항목 강조] */
        .input-required { background-color: #eff6ff !important; border-color: #bfdbfe !important; }
        
        /* [날짜 입력 필드 커스텀 디자인] */
        .list-date-input { 
            border: 1px solid #cbd5e1;
            border-radius: 4px; 
            padding: 4px 24px 4px 6px; 
            font-size: 11px; 
            font-family: 'JetBrains Mono', monospace; 
            color: #475569; 
            width: 110px;
            height: 30px;
            outline: none;
            background-color: #fff;
            cursor: pointer;
            text-align: center;
            transition: all 0.2s;
            position: relative;
            
            /* 달력 아이콘 배경 처리 */
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 24 24' stroke-width='1.5' stroke='%2394a3b8'%3E%3Cpath stroke-linecap='round' stroke-linejoin='round' d='M6.75 3v2.25M17.25 3v2.25M3 18.75V7.5a2.25 2.25 0 012.25-2.25h13.5A2.25 2.25 0 0121 7.5v11.25m-18 0A2.25 2.25 0 005.25 21h13.5A2.25 2.25 0 0021 18.75m-18 0v-7.5A2.25 2.25 0 015.25 9h13.5A2.25 2.25 0 0121 11.25v7.5' /%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: right 6px center;
            background-size: 14px;
        }
        .list-date-input:focus { 
            border-color: #3b82f6; 
            box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.1); 
        }

        /* 비활성화(ON 상태) 스타일 - 수정 불가 표시 */
        .list-date-input:disabled {
            background-color: #f8fafc;
            color: #94a3b8;
            border-color: #e2e8f0;
            cursor: not-allowed;
            /* 잠금 아이콘 */
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 24 24' stroke-width='1.5' stroke='%2394a3b8'%3E%3Cpath stroke-linecap='round' stroke-linejoin='round' d='M16.5 10.5V6.75a4.5 4.5 0 10-9 0v3.75m-.75 11.25h10.5a2.25 2.25 0 002.25-2.25v-6.75a2.25 2.25 0 00-2.25-2.25H6.75a2.25 2.25 0 00-2.25 2.25v6.75a2.25 2.25 0 002.25 2.25z' /%3E%3C/svg%3E");
        }

        /* 값이 없을 때 텍스트 숨김 (투명 처리) 후 가상요소로 텍스트 대체 */
        .list-date-input.is-empty { color: transparent; }
        
        .list-date-input.is-empty::before {
            content: attr(data-placeholder);
            color: #2563eb; 
            background-color: #eff6ff; 
            border: 1px solid #bfdbfe;
            border-radius: 4px;
            padding: 1px 6px;
            position: absolute;
            left: 50%;
            top: 50%;
            transform: translate(-50%, -50%);
            text-align: center;
            font-size: 10px;
            font-family: 'Noto Sans KR', sans-serif;
            font-weight: 700;
            pointer-events: none;
            white-space: nowrap;
            box-shadow: 0 1px 1px rgba(0,0,0,0.05);
        }
        
        /* 비활성화 시 플레이스홀더 스타일 */
        .list-date-input.is-empty:disabled::before {
            color: #94a3b8;
            background-color: transparent;
            border-color: transparent;
            box-shadow: none;
        }

        /* 시작일 미설정은 회색 처리 (덜 강조) */
        .list-date-input.is-empty[data-placeholder="시작일 설정"]::before {
            color: #94a3b8;
            background-color: transparent;
            border: none;
            box-shadow: none;
            font-weight: 500;
        }

        /* 브라우저 기본 UI 요소(스핀 버튼, X 버튼) 숨김 */
        .list-date-input::-webkit-inner-spin-button,
        .list-date-input::-webkit-outer-spin-button,
        .list-date-input::-webkit-clear-button {
            -webkit-appearance: none;
            margin: 0;
            display: none;
        }

        /* 전체 영역을 달력 트리거로 사용 (Overlay) */
        .list-date-input::-webkit-calendar-picker-indicator {
            position: absolute;
            top: 0; left: 0; width: 100%; height: 100%;
            opacity: 0; cursor: pointer; z-index: 10;
        }
        /* 비활성화 시 달력 버튼도 숨김 */
        .list-date-input:disabled::-webkit-calendar-picker-indicator {
            display: none;
        }

        /* 미리보기 박스 */
        .step4-box { background-color: #f8fafc; border: 1px solid #e2e8f0; border-radius: 8px; padding: 16px; }
        .result-box {
            background-color: #475569;
            border-radius: 6px;
            padding: 14px;
            color: #ffffff;
            font-family: 'JetBrains Mono', monospace;
            font-size: 12px;
            line-height: 1.6;
            word-break: break-all;
            box-shadow: inset 0 2px 4px rgba(0,0,0,0.1);
        }
    </style>
</head>
<body>

    <header class="bg-white border-b border-slate-200 px-8 py-4 mb-6 shadow-sm sticky top-0 z-50">
        <div class="flex justify-between items-center max-w-7xl mx-auto w-full">
            <h1 class="text-xl font-bold text-slate-800"><i class="fas fa-link text-blue-600 mr-2"></i>마케팅 링크 빌더 (관리자용)</h1>
            <div class="text-right">
                <span class="text-xs bg-slate-800 text-white px-2 py-1 rounded font-bold uppercase tracking-wider">Prototype Ver 3.19</span>
            </div>
        </div>
    </header>

    <div class="max-w-7xl mx-auto px-6 pb-20">

        <!-- 링크 생성 영역 -->
        <section class="mb-10">
            <div class="flex items-center gap-2 mb-3 border-l-4 border-blue-600 pl-3">
                <h2 class="text-base font-bold text-slate-700">신규 캠페인 생성</h2>
            </div>
            
            <div class="bg-white border border-slate-300 rounded-sm shadow-sm overflow-hidden">
                <table class="tbl_frm">
                    <tbody>
                        <!-- STEP 1 -->
                        <tr>
                            <th>
                                <div class="flex flex-col gap-1">
                                    <span class="bg-blue-600 text-white w-5 h-5 flex items-center justify-center rounded-full text-[10px] mb-1">1</span>
                                    <span>캠페인 정보 <span class="text-red-500">*</span></span>
                                </div>
                            </th>
                            <td colspan="3">
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                                    <div>
                                        <label class="block text-xs font-bold text-blue-800 mb-1.5 uppercase">캠페인 명 <span class="text-red-500">*</span></label>
                                        <input type="text" id="inputMemo" class="input-required w-full border px-3 py-2.5 rounded focus:outline-none text-sm font-bold text-slate-700 transition" placeholder="예: 26년 설날 감사 이벤트" oninput="updatePreview()">
                                    </div>
                                    <div>
                                        <div class="flex justify-between items-center mb-1.5">
                                            <label class="block text-xs font-bold text-slate-600 uppercase">담당 유통사 (yt_code)</label>
                                            <span class="text-[10px] text-slate-400 bg-slate-50 px-2 py-0.5 rounded border border-slate-200 leading-none">미입력 시 '본사'</span>
                                        </div>
                                        <input type="text" id="inputYt" class="w-full border border-slate-300 bg-white px-3 py-2.5 rounded focus:border-blue-500 focus:outline-none text-sm transition" placeholder="예: ABC001" oninput="updatePreview()">
                                    </div>
                                </div>
                            </td>
                        </tr>

                        <!-- STEP 2 -->
                        <tr>
                            <th>
                                <div class="flex flex-col gap-1">
                                    <span class="bg-slate-500 text-white w-5 h-5 flex items-center justify-center rounded-full text-[10px] mb-1">2</span>
                                    <span>연결 설정 <span class="text-red-500">*</span></span>
                                </div>
                            </th>
                            <td colspan="3">
                                <div class="flex flex-col gap-4">
                                    <div>
                                        <label class="block text-xs font-bold text-slate-600 mb-1 uppercase">광고/홍보 채널 <span class="text-blue-600 font-normal ml-1">(GA4 자동매핑)</span></label>
                                        <select id="inputSrc" class="input-required w-full md:w-1/2 border px-2 py-2 rounded focus:outline-none text-sm font-bold text-slate-700 transition" onchange="updatePreview()">
                                            <option value="referral" data-source="homepage" data-medium="referral">기본 (웹사이트/블로그)</option>
                                            <optgroup label="광고 (Paid)">
                                                <option value="paid_search" data-source="naver" data-medium="cpc">네이버 파워링크 (cpc)</option>
                                                <option value="paid_social" data-source="instagram" data-medium="paidsocial">인스타그램 광고</option>
                                            </optgroup>
                                        </select>
                                    </div>
                                    <div>
                                        <label class="block text-xs font-bold text-slate-700 mb-1 uppercase">랜딩페이지 (원본 URL) <span class="text-red-500">*</span></label>
                                        <input type="text" id="inputBaseUrl" class="input-required w-full border px-3 py-2.5 rounded text-slate-700 focus:outline-none shadow-sm font-medium transition" placeholder="https://orderz.kr/member/join.php" oninput="updatePreview()">
                                    </div>
                                </div>
                            </td>
                        </tr>

                        <!-- STEP 3 -->
                        <tr class="border-t border-slate-200">
                            <th>
                                <div class="flex flex-col gap-1">
                                    <span class="bg-slate-400 text-white w-5 h-5 flex items-center justify-center rounded-full text-[10px] mb-1">3</span>
                                    <span>회원가입 후 이동</span>
                                </div>
                            </th>
                            <td colspan="3">
                                <div class="md:col-span-2">
                                    <label class="block text-xs font-bold text-slate-700 mb-1 uppercase">이동 목적지 (Next URL)</label>
                                    <input type="text" id="inputNext" class="w-full border border-slate-300 bg-white px-3 py-2.5 rounded text-slate-600 focus:border-blue-500 focus:outline-none text-sm transition" placeholder="/event/coupon.php" oninput="updatePreview()">
                                    <div id="nextHint" class="text-[10px] mt-2 font-medium text-slate-500">
                                        미입력 시: 내부 유입은 이전페이지, 외부 유입은 홈(/)로 처리됩니다.
                                    </div>
                                </div>
                            </td>
                        </tr>

                        <!-- STEP 4 -->
                        <tr class="bg-blue-50/30 border-t border-blue-200">
                            <th>
                                <div class="flex flex-col gap-1">
                                    <span class="bg-blue-600 text-white w-5 h-5 flex items-center justify-center rounded-full text-[10px] mb-1">4</span>
                                    <span>링크 생성 <span class="text-red-500">*</span></span>
                                </div>
                            </th>
                            <td colspan="3">
                                <div class="step4-box mb-4 shadow-sm">
                                    <div class="flex items-center gap-2 mb-3">
                                        <span class="text-[10px] bg-slate-500 text-white px-2 py-0.5 rounded font-bold uppercase tracking-widest">1. 조합 결과 (Long URL)</span>
                                        <span class="text-[10px] text-slate-400 italic font-medium">* 설정값이 자동 적용된 결과 주소입니다.</span>
                                    </div>
                                    <div id="previewUrl" class="result-box select-all">
                                        https://orderz.kr/member/join.php?utm_source=homepage&utm_medium=referral
                                    </div>
                                </div>

                                <div class="step4-box border-blue-100 shadow-sm">
                                    <div class="flex items-center gap-2 mb-3">
                                        <span class="text-[10px] bg-blue-600 text-white px-2 py-0.5 rounded font-bold uppercase tracking-widest">2. 단축 코드 (Short Code)</span>
                                        <span class="text-[10px] text-blue-600 font-normal italic font-medium">*(영문, 숫자, _만 가능) 예: summer_sale_2026_01</span>
                                    </div>
                                    <div class="flex items-center gap-3">
                                        <div class="flex items-center flex-1 max-w-[450px]">
                                            <span class="inline-flex items-center px-3 h-11 rounded-l-lg border border-r-0 border-slate-300 bg-white text-slate-500 text-sm font-mono font-bold">orderz.kr/l/</span>
                                            <input type="text" id="inputCode" class="input-required flex-1 h-11 border px-3 rounded-r-lg focus:outline-none font-bold text-lg text-slate-800 shadow-sm transition" placeholder="sale_20260130" oninput="updatePreview()">
                                        </div>
                                        <button onclick="createLink()" class="px-10 h-11 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition text-sm font-bold flex items-center justify-center gap-2 whitespace-nowrap shadow-md transform active:scale-95">
                                            <i class="fas fa-link"></i> 링크 생성
                                        </button>
                                    </div>
                                </div>
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </section>

        <!-- 관리 목록 -->
        <section>
            <div class="flex justify-between items-start mb-4 px-1">
                <div class="flex flex-col gap-1.5">
                    <h2 class="text-base font-bold text-slate-700 border-l-4 border-slate-600 pl-3">생성 목록</h2>
                    <p class="text-[11px] text-slate-500 ml-4 font-medium tracking-tight">※ 상태 구분: 정지중(OFF) / 예약중 / 운영중 + <span class="text-red-600 font-bold">만료됨(기간지남)</span></p>
                </div>
                <div class="flex flex-col items-end gap-2">
                    <p class="text-[10px] text-blue-500 font-semibold italic">※ 쉼표(,)를 사용하여 캠페인명, 단축코드, 유통사, 채널을 다중 검색할 수 있습니다.</p>
                    <div class="relative">
                        <i class="fas fa-search absolute left-3 top-1/2 -translate-y-1/2 text-slate-400 text-xs"></i>
                        <input type="text" id="searchInput" placeholder="검색어 입력 (예: 여름, OFF001)" class="border border-slate-300 pl-9 pr-4 py-2.5 text-xs rounded-lg w-[400px] outline-none focus:border-blue-500 transition shadow-sm bg-white font-medium" onkeyup="filterList()">
                    </div>
                </div>
            </div>

            <div class="tbl_head_container">
                <table class="tbl_head">
                    <thead>
                        <tr>
                            <!-- [Ver 3.19] 레이아웃 밸런스 조정: 캠페인 20% / 링크정보 확장 -->
                            <th style="width: 20%;">캠페인 정보 / 유통사</th>
                            <th style="width: 310px;" class="text-center">운영 설정 (ON/OFF + 기간)</th>
                            <th style="width: 90px;" class="text-center">현재 상태</th>
                            <th style="width: 90px;" class="text-center">성과(Hits)</th>
                            <th style="width: auto;">연결 링크 정보</th>
                        </tr>
                    </thead>
                    <tbody id="linkListBody"></tbody>
                </table>
            </div>
        </section>
    </div>

    <script>
        // [시뮬레이션 환경] 오늘 날짜 기준
        const TODAY = "2026-01-30";
        
        // 초기 데이터 (시뮬레이터용)
        // [개발자 참조] 실제 구현 시 DB에서 이 구조의 배열을 JSON으로 받아와 렌더링해야 함.
        let linkData = [
            { id: 104, code: "feb_event", full_url: "https://orderz.kr/join?utm_campaign=feb_event", memo: "2월 설날 감사 이벤트", yt: "-", active: false, hits: 154, last_hit_at: "2026-01-29 14:30:00", channel: "messaging", start_date: "2026-02-01", end_date: "2026-02-28" },
            { id: 103, code: "jan_sale", full_url: "https://orderz.kr/join?utm_campaign=jan_sale", memo: "1월 시즌오프 세일", yt: "OFF001", active: true, hits: 1450, last_hit_at: "2026-01-30 10:20:11", channel: "paid_social", start_date: "2026-01-01", end_date: "2026-02-15" }
        ];

        const DOM = {
            inputBaseUrl: document.getElementById('inputBaseUrl'),
            inputSrc: document.getElementById('inputSrc'),
            inputMemo: document.getElementById('inputMemo'),
            inputYt: document.getElementById('inputYt'),
            inputCode: document.getElementById('inputCode'),
            inputNext: document.getElementById('inputNext'),
            listBody: document.getElementById('linkListBody'),
            previewUrl: document.getElementById('previewUrl')
        };

        // Next URL 검증 (보안)
        function normalizeNext(raw) {
            const v = (raw || '').trim();
            if (!v) return ''; 
            if (!v.startsWith('/')) return '__INVALID__'; 
            if (v.startsWith('//')) return '__INVALID__'; // 프로토콜 상대 경로 차단
            if (v.includes('://')) return '__INVALID__'; // 절대 경로 차단
            if (v.includes('\\')) return '__INVALID__'; // 역슬래시 변종 차단
            return v;
        }

        // 스크롤 휠 날짜 변경 방지 (UX)
        document.addEventListener('wheel', (e) => {
            if (document.activeElement && document.activeElement.type === 'date') {
                e.preventDefault();
            }
        }, { passive: false });

        // 미리보기 업데이트
        function updatePreview() {
            const baseUrl = DOM.inputBaseUrl.value.trim() || ''; 
            const campaignKey = DOM.inputCode.value.trim();
            const ytCode = DOM.inputYt.value.trim();
            const selectedOption = DOM.inputSrc.options[DOM.inputSrc.selectedIndex];
            
            const nextInputEl = DOM.inputNext;
            let next = nextInputEl.value.trim();
            const nextHintId = 'nextHint';
            let hintEl = document.getElementById(nextHintId);

            if (!hintEl) {
                hintEl = document.createElement('div');
                hintEl.id = nextHintId;
                hintEl.className = 'text-[10px] mt-2 font-medium';
                nextInputEl.parentNode.appendChild(hintEl);
            }

            const check = normalizeNext(next);
            if (next && check === '__INVALID__') {
                nextInputEl.classList.add('border-red-400', 'bg-red-50');
                hintEl.className = 'text-[10px] mt-2 font-bold text-red-500';
                hintEl.innerHTML = "<i class='fas fa-exclamation-circle mr-1'></i>보안상 <b>'/'</b>로 시작하는 내부 경로만 가능합니다. 예) <b>/event/coupon.php</b>";
                next = ''; 
            } else {
                nextInputEl.classList.remove('border-red-400', 'bg-red-50');
                hintEl.className = 'text-[10px] mt-2 font-medium text-slate-500';
                hintEl.innerHTML = "미입력 시: 내부 유입은 이전페이지, 외부 유입은 홈(/)로 처리됩니다.";
            }

            if (!baseUrl) {
                DOM.previewUrl.textContent = "랜딩페이지 URL을 입력해주세요.";
                return "";
            }

            let params = [];
            if (selectedOption.dataset.source) params.push(`utm_source=${selectedOption.dataset.source}`);
            if (selectedOption.dataset.medium) params.push(`utm_medium=${selectedOption.dataset.medium}`);
            if (campaignKey) params.push(`utm_campaign=${campaignKey}`);
            if (ytCode) params.push(`yt_code=${encodeURIComponent(ytCode)}`);
            if (next) params.push(`next=${encodeURIComponent(next)}`);

            const separator = baseUrl.includes('?') ? '&' : '?';
            const finalUrl = params.length > 0 ? `${baseUrl}${separator}${params.join('&')}` : baseUrl;
            DOM.previewUrl.textContent = finalUrl;
            return finalUrl;
        }

        // 상태 로직 (Primary / Secondary)
        function getStatusInfo(item) {
            let primary = { label: '운영중', class: 'badge-running' };
            let isExpired = false;

            if (item.end_date && TODAY > item.end_date) {
                isExpired = true;
            }

            if (!item.active) {
                primary = { label: '정지중', class: 'badge-stopped' };
            } else if (item.start_date && TODAY < item.start_date) {
                primary = { label: '예약중', class: 'badge-waiting' };
            } else {
                primary = { label: '운영중', class: 'badge-running' };
            }

            return { primary, isExpired };
        }

        // 전체 목록 렌더링
        function renderList(data = linkData) {
            DOM.listBody.innerHTML = "";
            const sortedData = [...data].sort((a, b) => b.id - a.id);

            sortedData.forEach(item => {
                const { primary, isExpired } = getStatusInfo(item);
                const tr = document.createElement('tr');
                tr.id = `row-${item.id}`; 
                tr.className = item.active ? 'hover:bg-slate-50 transition' : 'bg-slate-50/80 grayscale-[0.8] transition';
                
                const startClass = item.start_date ? '' : 'is-empty';
                const endClass = item.end_date ? '' : 'is-empty';

                const disabledAttr = item.active ? 'disabled' : '';
                const disabledTooltip = item.active ? 'title="운영 중에는 기간을 변경할 수 없습니다. (OFF 후 수정)"' : '';

                let statusHtml = '';
                if (isExpired) {
                    statusHtml += `<span class="badge badge-expired">만료됨</span>`;
                }
                statusHtml += `<span class="badge ${primary.class}">${primary.label}</span>`;

                tr.innerHTML = `
                    <td>
                        <div class="font-bold text-slate-800 text-sm truncate" title="${item.memo}">${item.memo}</div>
                        <div class="text-[11px] text-slate-400">유통사: ${item.yt === '-' ? '본사직영' : item.yt}</div>
                    </td>
                    <td class="text-center">
                        <div class="flex items-center justify-center gap-3">
                            <div class="relative inline-block w-8 align-middle select-none shrink-0" title="운영 상태 토글">
                                <input type="checkbox" id="toggle-${item.id}" class="toggle-checkbox absolute block w-4 h-4 rounded-full bg-white border-2 appearance-none cursor-pointer border-slate-300 transition-all duration-300 ease-in-out" ${item.active ? 'checked' : ''} onchange="toggleActive(${item.id})"/>
                                <label for="toggle-${item.id}" class="toggle-label block overflow-hidden h-4 rounded-full bg-slate-300 cursor-pointer transition-colors duration-300 ease-in-out"></label>
                            </div>
                            <div class="h-6 w-px bg-slate-200"></div>
                            <div class="flex items-center gap-1.5" ${disabledTooltip}>
                                <input type="date" id="date-start-${item.id}" class="list-date-input ${startClass}" value="${item.start_date || ''}" oninput="updateDate(${item.id}, 'start', this.value)" data-placeholder="시작일 설정" onkeydown="return false" ${disabledAttr}>
                                <span class="text-slate-300 font-bold mx-1">~</span>
                                <input type="date" id="date-end-${item.id}" class="list-date-input ${endClass}" value="${item.end_date || ''}" oninput="updateDate(${item.id}, 'end', this.value)" data-placeholder="상시 운영" onkeydown="return false" ${disabledAttr}>
                            </div>
                        </div>
                    </td>
                    <td class="text-center align-middle">
                        <div id="status-cell-${item.id}" class="flex flex-col items-center justify-center">
                            ${statusHtml}
                        </div>
                    </td>
                    <td class="text-center">
                        <div class="text-sm font-mono font-bold text-slate-700">${item.hits.toLocaleString()}</div>
                        <div class="text-[9px] text-slate-400">${item.last_hit_at ? item.last_hit_at : '-'}</div>
                    </td>
                    <td class="bg-slate-50/40">
                        <div class="text-[10px] text-slate-400 truncate opacity-60 font-mono mb-1">${item.full_url}</div>
                        <div class="flex items-center justify-between">
                            <span class="text-blue-600 font-bold text-[14px] font-mono cursor-pointer hover:underline" onclick="copyCode('${item.code}')">orderz.kr/l/${item.code}</span>
                        </div>
                    </td>
                `;
                DOM.listBody.append(tr);
            });
        }

        // 부분 업데이트 (DOM 보존)
        function updateRowUI(id) {
            const item = linkData.find(l => l.id === id);
            if (!item) return;

            const { primary, isExpired } = getStatusInfo(item);
            let statusHtml = '';
            if (isExpired) statusHtml += `<span class="badge badge-expired">만료됨</span>`;
            statusHtml += `<span class="badge ${primary.class}">${primary.label}</span>`;
            
            const statusCell = document.getElementById(`status-cell-${id}`);
            if (statusCell) {
                statusCell.innerHTML = statusHtml;
            }

            const startInput = document.getElementById(`date-start-${id}`);
            const endInput = document.getElementById(`date-end-${id}`);

            if (startInput) {
                item.start_date ? startInput.classList.remove('is-empty') : startInput.classList.add('is-empty');
            }
            if (endInput) {
                item.end_date ? endInput.classList.remove('is-empty') : endInput.classList.add('is-empty');
            }
        }

        function createLink() {
            const memo = DOM.inputMemo.value.trim();
            const code = DOM.inputCode.value.trim();
            const baseUrl = DOM.inputBaseUrl.value.trim();
            const nextNorm = normalizeNext(DOM.inputNext.value);

            if (!memo || !code || !baseUrl) return alert("필수 항목(*)을 모두 입력해 주세요.");
            if (nextNorm === '__INVALID__') return alert("[생성 실패]\n최종 목적지(Next URL)는 반드시 '/'로 시작하는 내부 경로여야 합니다.\n\n올바른 예: /event/coupon.php");

            const longUrl = updatePreview();
            if (!longUrl) return alert("랜딩페이지(원본 URL)를 입력해 주세요.");

            // 신규 데이터 추가 (NULL 정책 준수)
            linkData.push({ 
                id: Date.now(), code, full_url: longUrl, memo, 
                yt: DOM.inputYt.value.trim() || '-', 
                active: false, hits: 0, last_hit_at: null, 
                channel: DOM.inputSrc.value, 
                start_date: null, 
                end_date: null 
            });

            renderList();
            alert("링크가 생성되었습니다. (상태: 정지중)\n목록에서 'ON' 버튼을 눌러 운영을 시작해주세요.");
            DOM.inputMemo.value = DOM.inputYt.value = DOM.inputCode.value = DOM.inputNext.value = "";
            updatePreview();
        }

        // 토글 동작 (중복 및 날짜 검증)
        function toggleActive(id) {
            const target = linkData.find(l => l.id === id);
            if (!target) return;
            
            // OFF -> ON 시도 시 (검증)
            if (!target.active) {
                const isDuplicated = linkData.some(l => l.code === target.code && l.active && l.id !== id);
                if (isDuplicated) {
                    alert(`[운영 불가]\n이미 동일 코드(${target.code})가 '운영중' 입니다.\n기존 링크를 먼저 끄고 다시 시도해주세요.`);
                    renderList(); return;
                }
                
                if (target.start_date && target.end_date && target.start_date > target.end_date) {
                    alert(`[설정 오류]\n시작일(${target.start_date})이 종료일(${target.end_date})보다 늦습니다.\n날짜를 올바르게 수정한 후 켜주세요.`);
                    renderList(); return;
                }
            }
            
            target.active = !target.active;
            renderList(); // 전체 렌더링 (disabled 속성 변경을 위해)
        }

        function copyCode(code) {
            const text = `https://orderz.kr/l/${code}`;
            const t = document.createElement("textarea"); document.body.appendChild(t); t.value = text; t.select(); document.execCommand('copy'); document.body.removeChild(t);
            alert(`복사되었습니다: ${text}`);
        }

        // 날짜 업데이트 (ON 상태 수정 차단 확인)
        function updateDate(id, type, value) {
            const item = linkData.find(l => l.id === id);
            if (!item) return;

            // HTML에서 disabled 처리되어 있지만, 이중 방어
            if (item.active) return; 

            // 빈값 -> NULL 처리
            const v = value === "" ? null : value;
            
            if (type === 'start') item.start_date = v;
            else item.end_date = v;
            
            updateRowUI(id);
        }

        function filterList() {
            const kw = document.getElementById('searchInput').value.toLowerCase();
            if (!kw) { renderList(linkData); return; }
            const keywords = kw.split(',').map(k => k.trim()).filter(k => k);
            const filtered = linkData.filter(l => keywords.some(k => 
                String(l.memo || '').toLowerCase().includes(k) || String(l.code || '').toLowerCase().includes(k) || 
                String(l.yt || '').toLowerCase().includes(k) || String(l.channel || '').toLowerCase().includes(k)
            ));
            renderList(filtered);
        }

        updatePreview();
        renderList();
    </script>
</body>
</html>
