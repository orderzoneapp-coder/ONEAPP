<!DOCTYPE html>
<html lang="ko" translate="no">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="google" content="notranslate">
    <title>ORDERZ - NHÎùºÏù∏ Ï£ºÎ¨∏ ÏãúÎÆ¨Î†àÏù¥ÏÖò</title>
    <style>
        /* --- Reset & Base Styles --- */
        * { box-sizing: border-box; margin: 0; padding: 0; outline: none; -webkit-tap-highlight-color: transparent; }
        .goog-te-banner-frame { display: none !important; }
        .goog-tooltip { display: none !important; }
        body { background-color: #f5f5f5; display: flex; justify-content: center; height: 100vh; height: 100dvh; color: #222; font-family: -apple-system, BlinkMacSystemFont, "Apple SD Gothic Neo", sans-serif; overflow: hidden; }
        
        /* --- App Container --- */
        .app-container { width: 100%; max-width: 480px; background-color: #fff; position: relative; display: flex; flex-direction: column; height: 100%; box-shadow: 0 0 20px rgba(0,0,0,0.05); }

        /* --- Variables --- */
        :root { 
            --primary: #1faa5e; --primary-dark: #179c54; --primary-light: #e8f5e9;
            --text-main: #111; --text-sub: #767676; --border: #ececec;
            --bg-gray: #f8f9fa; --nav-height: 56px; --bottom-bar-height: 76px;
        }

        /* --- Header (T-G3) --- */
        header { 
            height: var(--nav-height); padding: 0 12px; display: flex; justify-content: space-between; align-items: center; 
            background: #fff; z-index: 100; border-bottom: 1px solid var(--border); flex-shrink: 0; position: relative;
        }
        
        /* Header Button: Mode Switcher (ÏÉÅÎã® Ï¢åÏ∏°) */
        .header-mode-btn { 
            background: transparent; 
            border: 1px solid transparent; 
            padding: 6px 4px; 
            border-radius: 8px; 
            font-size: 13px; 
            font-weight: 600; 
            color: #333; 
            display: flex; 
            align-items: center; 
            gap: 6px; 
            cursor: pointer; 
            transition: background-color 0.2s;
        }
        .header-mode-btn:active { background-color: #f0f0f0; }
        .header-mode-btn svg { width: 20px; height: 20px; stroke-width: 2; }

        /* Title Center (Ï§ëÏïô Ìôà Î≤ÑÌäº) */
        .header-center-title { 
            position: absolute; 
            left: 50%; 
            transform: translateX(-50%); 
            font-size: 18px; 
            font-weight: 800; 
            cursor: pointer; 
            transition: all 0.1s;
            padding: 4px 8px; /* ÌÑ∞Ïπò ÏòÅÏó≠ ÌôïÎ≥¥ */
        }
        /* ÌÅ¥Î¶≠ ÌîºÎìúÎ∞± */
        .header-center-title:active { 
            opacity: 0.6; 
            transform: translateX(-50%) scale(0.96); 
        }
        
        /* Profile Group: 0P Left, Icon Right */
        .header-profile-group { 
            display: flex; 
            flex-direction: row; 
            align-items: flex-end; 
            justify-content: center;
            gap: 4px; 
            color: #444; 
            border: none; 
            background: none; 
            cursor: pointer; 
            padding: 0 4px;
            min-width: 44px; 
        }
        .header-profile-group svg { width: 24px; height: 24px; stroke-width: 1.8; }
        .header-profile-group span { 
            font-size: 10px; 
            font-weight: 600; 
            color: #888; 
            line-height: 1;
            margin-bottom: 2px; 
        }

        /* --- Scroll Areas --- */
        .content-scroll { flex: 1; overflow-y: auto; background: #fff; padding-bottom: calc(var(--bottom-bar-height) + 20px); -webkit-overflow-scrolling: touch; }
        .content-scroll.bg-gray { background: var(--bg-gray); }

        /* --- Mall Mode Specifics (T-P1) --- */
        .mall-category-nav { display: flex; justify-content: space-around; padding: 12px 0; background: #fff; border-bottom: 1px solid #f0f0f0; }
        .mall-cat-item { display: flex; flex-direction: column; align-items: center; gap: 6px; width: 20%; cursor: pointer; opacity: 0.7; transition: opacity 0.2s; }
        .mall-cat-item.active { opacity: 1; font-weight: bold; color: var(--primary); }
        .mall-cat-icon { width: 44px; height: 44px; background: #f8f9fa; border-radius: 16px; display: flex; align-items: center; justify-content: center; font-size: 20px; border: 1px solid #eee; }
        .mall-cat-item.active .mall-cat-icon { background: var(--primary-light); border-color: var(--primary); }
        .mall-cat-text { font-size: 11px; }

        /* Search Bar Overlay (CMD-A1: Layer over category bar) */
        .search-bar-area {
            padding: 12px 16px;
            background: #fff;
            border-bottom: 1px solid #f0f0f0;
            display: none; 
        }
        .search-input-wrapper {
            position: relative;
            display: flex;
            align-items: center;
        }
        .search-input {
            width: 100%;
            height: 44px;
            background: #f5f5f5;
            border: 1px solid #eee;
            border-radius: 8px;
            padding: 0 40px 0 16px;
            font-size: 15px;
            color: #111;
        }
        .search-input:focus { border-color: #ddd; background: #fff; }
        .search-close-btn {
            position: absolute;
            right: 8px;
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            border: none;
            background: none;
            color: #999;
            font-size: 18px;
            cursor: pointer;
        }

        /* Search Summary Bar (CMD-B2) */
        .search-summary-bar {
            padding: 16px;
            font-size: 15px;
            color: #444;
            border-bottom: 1px solid #f0f0f0;
            background: #fff;
            display: flex;
            align-items: center;
        }
        .search-keyword { font-weight: 800; color: #111; }

        /* Banner Style */
        .banner-container {
            padding: 16px;
            transition: all 0.3s cubic-bezier(0.25, 0.8, 0.25, 1);
            overflow: hidden;
            max-height: 122px; 
            opacity: 1;
        }
        .banner-container.collapsed {
            max-height: 0;
            padding-top: 0;
            padding-bottom: 0;
            opacity: 0;
            margin: 0;
        }
        .banner-content {
            background: linear-gradient(135deg, #e0f2f1, #b2dfdb); 
            height: 90px; 
            border-radius: 12px; 
            display: flex; 
            align-items: center; 
            justify-content: center; 
            color: #00695c; 
            font-weight: 800; 
            font-size: 18px;
        }

        /* Tabs */
        .mall-tab-bar { display: flex; gap: 8px; padding: 0 16px 12px; border-bottom: 1px solid #f0f0f0; margin-top: 10px; }
        .mall-sub-tab { flex: 1; padding: 10px 0; border-radius: 12px; border: 1px solid #eee; font-size: 14px; color: #666; cursor: pointer; background: #fff; text-align: center; transition: all 0.2s; }
        .mall-sub-tab.active { background: #222; color: #fff; border-color: #222; font-weight: 700; box-shadow: 0 2px 8px rgba(0,0,0,0.1); }

        /* --- Product Item --- */
        .product-item { display: flex; padding: 16px; border-bottom: 1px solid #f0f0f0; background: #fff; align-items: flex-start; }
        .product-item.selected { background-color: #f0fdf4; }
        
        .prod-chk-area { display: flex; align-items: center; justify-content: center; cursor: pointer; align-self: center; margin-left: 10px; }
        
        .prod-chk-square {
            width: 24px;
            height: 24px;
            border: 2px solid #ddd;
            border-radius: 4px; 
            background: #fff;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
        }

        .product-item.selected .prod-chk-square { background: var(--primary); border-color: var(--primary); }
        .prod-chk-square svg { width: 16px; height: 16px; fill: none; stroke: #fff; stroke-width: 3; stroke-linecap: round; stroke-linejoin: round; display: none; }
        .product-item.selected .prod-chk-square svg { display: block; }

        .prod-img { width: 72px; height: 72px; background: #f8f9fa; border-radius: 8px; margin-right: 12px; display: flex; align-items: center; justify-content: center; font-size: 30px; flex-shrink: 0; }
        .prod-info { flex: 1; display: flex; flex-direction: column; min-width: 0; }
        .prod-name { font-size: 16px; font-weight: 600; margin-bottom: 4px; line-height: 1.3; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
        .prod-unit { font-size: 12px; color: #999; margin-bottom: 6px; }
        .prod-price { font-size: 17px; font-weight: 800; color: #111; }

        /* Mall Mode: Checkbox on Right */
        .mall-item .prod-chk-area { order: 2; }
        .mall-item .prod-content { order: 1; flex: 1; display: flex; }
        
        /* Order Mode: No Checkbox */
        .order-item .prod-chk-area { display: none; }
        .order-item .prod-content { order: 1; flex: 1; display: flex; }

        /* --- Bottom CTA (T-G2) --- */
        .bottom-bar { 
            position: absolute; bottom: 0; width: 100%; height: calc(var(--bottom-bar-height) + env(safe-area-inset-bottom));
            background: #fff; border-top: 1px solid #eee; display: flex; align-items: center; padding: 0 12px env(safe-area-inset-bottom);
            box-shadow: 0 -4px 16px rgba(0,0,0,0.05); z-index: 200; gap: 8px;
        }
        
        .icon-btn { flex: 1; height: 50px; display: flex; align-items: center; justify-content: center; border-radius: 12px; border: none; background: #fff; box-shadow: 0 2px 6px rgba(0,0,0,0.05); cursor: pointer; color: #555; }
        
        .main-cta-btn { 
            flex: 1; height: 50px; border-radius: 12px; border: none; font-weight: 700; font-size: 15px; cursor: pointer;
            display: flex; flex-direction: column; align-items: center; justify-content: center; line-height: 1.2;
            transition: all 0.2s;
        }
        
        .cta-default { background: #fff; color: #111; border: 1px solid #eee; }
        .cta-brand { color: var(--primary); font-size: 10px; font-weight: 900; margin-bottom: 2px; filter: saturate(0.85); }

        /* Coach Mark */
        .coach-mark { 
            position: absolute; top: 54px; left: 10px; background: rgba(30, 30, 30, 0.95); color: #fff; padding: 12px 16px; border-radius: 10px; font-size: 13px; line-height: 1.5; opacity: 0; pointer-events: none; transition: opacity 0.3s; z-index: 2000; box-shadow: 0 4px 12px rgba(0,0,0,0.2); max-width: 260px; word-break: keep-all;
        }
        .coach-mark::before { content: ''; position: absolute; top: -6px; left: 20px; width: 0; height: 0; border-left: 6px solid transparent; border-right: 6px solid transparent; border-bottom: 6px solid rgba(30, 30, 30, 0.95); }
        .coach-mark.show { opacity: 1; }
        .coach-mark b { color: #81c784; }

        /* Toast */
        .toast { position: fixed; bottom: 100px; left: 50%; transform: translateX(-50%); background: rgba(0,0,0,0.8); color: white; padding: 12px 24px; border-radius: 24px; font-size: 14px; opacity: 0; pointer-events: none; transition: opacity 0.3s; z-index: 2000; width: max-content; max-width: 80%; text-align: center; }
        .toast.show { opacity: 1; }

        /* Icons */
        .icon { width: 24px; height: 24px; stroke: currentColor; fill: none; stroke-width: 2; stroke-linecap: round; stroke-linejoin: round; }
    </style>
</head>
<body>

    <div class="app-container">
        <!-- HEADER (T-G3) -->
        <header>
            <!-- 
                Î™®Îìú Ïä§ÏúÑÏπò: Ìï≠ÏÉÅ Ïú†ÏßÄ (Í≤ÄÏÉâ Ï§ëÏóêÎèÑ Ïú†ÏßÄ)
                ÌÅ¥Î¶≠ Ïãú: Î™®Îìú Ï†ÑÌôò (Í≤ÄÏÉâ Ï¢ÖÎ£å Ìö®Í≥º Ìè¨Ìï®)
            -->
            <button class="header-mode-btn" id="modeSwitchBtn" onclick="app.handleHeaderLeftBtn()">
                <!-- JS Injected dynamically -->
            </button>

            <!-- Ï§ëÏïô ÌÉÄÏù¥ÌãÄ: ÏáºÌïëÎ™∞ Ìôà(ÏÉÅÌíàÎ™©Î°ù) Î≥µÍ∑Ä -->
            <div class="header-center-title" onclick="app.resetHome()">NHÎùºÏù∏</div>
            
            <!-- Profile -->
            <button class="header-profile-group">
                <span>0P</span>
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round">
                    <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path>
                    <circle cx="12" cy="7" r="4"></circle>
                </svg>
            </button>
        </header>

        <!-- Coach Mark -->
        <div id="coachMark" class="coach-mark"></div>

        <!-- PAGE 1: MALL MODE (Product Viewing Home) -->
        <div id="pageMall" class="content-scroll" style="display:none;">
            <!-- Category Nav (Replaced by Search Input in Search Mode) -->
            <div id="categoryNavArea" class="mall-category-nav">
                <!-- JS Injected (UI Only) -->
            </div>

            <!-- CMD-A1: Search Input Layer -->
            <div id="searchBarArea" class="search-bar-area">
                <div class="search-input-wrapper">
                    <input type="text" id="searchInput" class="search-input" placeholder="ÏÉÅÌíàÎ™Ö Í≤ÄÏÉâ" onkeyup="app.handleSearchInput(this.value)">
                    <!-- CMD-C1: Close Trigger (X) -->
                    <button class="search-close-btn" onclick="app.closeSearch()">‚úï</button>
                </div>
            </div>

            <!-- Banner Area (Collapsible) -->
            <div id="mallBanner" class="banner-container">
                <div class="banner-content">
                    NH SALE FESTA
                </div>
            </div>

            <!-- Sub Tabs (Theme Bar) -->
            <div class="mall-tab-bar" id="mallTabs">
                <div class="mall-sub-tab active" onclick="app.setMallTab('today')">Ïò§ÎäòÏùòÌñâÏÇ¨</div>
                <div class="mall-sub-tab" onclick="app.setMallTab('store')">Îß§Ïû•ÌñâÏÇ¨</div>
            </div>

            <!-- List Area -->
            <div id="mallListContainer">
                <!-- Items Injected (Includes CMD-B2 Summary Bar) -->
            </div>
        </div>

        <!-- PAGE 2: ORDER MODE (Order List) -->
        <div id="pageOrder" class="content-scroll bg-gray" style="display:none;">
            <div style="padding:40px; text-align:center; color:#999;">
                <h3>Ï£ºÎ¨∏ÏÑú (Order Mode)</h3>
                <p style="margin-top:10px; font-size:13px;">Îã¥ÏùÄ ÏÉÅÌíàÏùÑ ÌôïÏù∏ÌïòÏÑ∏Ïöî</p>
                <div id="orderListContainer" style="margin-top:20px; text-align:left; background:#fff;"></div>
            </div>
        </div>

        <!-- BOTTOM CTA (T-G2) -->
        <div class="bottom-bar">
            <!-- CMD-A1: Search Entry Trigger -->
            <button class="icon-btn" onclick="app.openSearch()">
                <svg class="icon" viewBox="0 0 24 24"><circle cx="11" cy="11" r="8"></circle><line x1="21" y1="21" x2="16.65" y2="16.65"></line></svg>
            </button>
            
            <button id="mainCtaBtn" class="main-cta-btn" onclick="app.handleCtaClick()">
                <!-- JS Injected by State Machine -->
            </button>
            
            <button class="icon-btn"><svg class="icon" viewBox="0 0 24 24"><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"></path></svg></button>
        </div>
    </div>

    <div id="toast" class="toast">Î©îÏãúÏßÄ</div>

    <script>
        // --- Data Mock ---
        const RAW_DB = [
            { id: 101, name: "Îã§Î∂ÄÎ¶¨ Î∞∞Ï∂î 4Ìè¨Í∏∞ BOX", unit: "BOX", price: 12500, img: "ü•¨", cat: "Ï±ÑÏÜå", tag: "best", type: "today" },
            { id: 102, name: "Ï≤≠ÏñëÍ≥†Ï∂î (Ìäπ) 10kg", unit: "BOX", price: 45000, img: "üå∂Ô∏è", cat: "Ï±ÑÏÜå", tag: "", type: "store" },
            { id: 103, name: "Ï†úÏ£º ÏÑ∏Ï≤ô Î¨¥Ïö∞ 20kg", unit: "BOX", price: 18000, img: "ü•î", cat: "Ï±ÑÏÜå", tag: "event", type: "today" },
            { id: 201, name: "ÎÉâÎèô ÏÇºÍ≤πÏÇ¥ 1kg", unit: "PK", price: 13500, img: "ü•ì", cat: "Ï∂ïÏÇ∞", tag: "best", type: "store" },
            { id: 202, name: "ÎÖ∏Î•¥Ïõ®Ïù¥ Í≥†Îì±Ïñ¥ 1ÏÜê", unit: "EA", price: 4500, img: "üêü", cat: "ÏàòÏÇ∞", tag: "event", type: "today" },
            { id: 301, name: "CJ ÌñáÎ∞ò 24ÏûÖ", unit: "BOX", price: 21900, img: "üçö", cat: "ÏãùÌíà", tag: "", type: "store" },
            { id: 302, name: "ÏÑúÏö∏Ïö∞Ïú† 1L", unit: "EA", price: 2800, img: "ü•õ", cat: "ÏãùÌíà", tag: "best", type: "today" },
            { id: 401, name: "Î∞±ÏÑ§ ÏÑ§ÌÉï 15kg", unit: "PO", price: 21000, img: "üç¨", cat: "ÏñëÎÖê", tag: "", type: "store" },
            { id: 501, name: "ÌÅ¨Î¶∞Îû© 30cm", unit: "EA", price: 3500, img: "üóûÔ∏è", cat: "Ïû°Ìôî", tag: "", type: "store" },
            { id: 502, name: "Ï¢ÖÏù¥Ïªµ 1000Îß§", unit: "BOX", price: 8500, img: "ü•§", cat: "Ïû°Ìôî", tag: "", type: "store" },
            { id: 402, name: "ÏÉòÌëú Í∞ÑÏû• 1.8L", unit: "EA", price: 5600, img: "üç∂", cat: "ÏñëÎÖê", tag: "best", type: "today" },
        ];

        const CATEGORIES = [
            { id: 'Ï±ÑÏÜå', icon: 'ü•¨', label: 'Ï±ÑÏÜå.Í≥ºÏùº' },
            { id: 'Ï∂ïÏÇ∞', icon: 'ü•©', label: 'Ï∂ïÏÇ∞.ÏàòÏÇ∞' },
            { id: 'ÏãùÌíà', icon: 'ü•§', label: 'ÏãùÌíà.ÏùåÎ£å' },
            { id: 'ÏñëÎÖê', icon: 'üßÇ', label: 'ÏñëÎÖê.ÏÜåÏä§' },
            { id: 'Ïû°Ìôî', icon: 'ü•£', label: 'Ï£ºÎ∞©.Ïû°Ìôî' }
        ];

        // --- T-G1: Global State Management ---
        class AppState {
            constructor() { 
                this.isSearchMode = false; // Search Overlay State
                this.searchQuery = '';
            }

            load() {
                const saved = localStorage.getItem('nh_sim_state');
                if (saved) {
                    const parsed = JSON.parse(saved);
                    this.mode = parsed.mode || 'mall';
                    this.selectedIds = new Set(parsed.selectedIds || []);
                    this.cart = parsed.cart || {}; 
                    this.mallTab = parsed.mallTab || 'today';
                    this.mallCat = parsed.mallCat || null;
                } else {
                    this.resetSession();
                }
                
                if (typeof renderManager !== 'undefined' && typeof ctaManager !== 'undefined') {
                    renderManager.update();
                    ctaManager.update();
                }
            }

            resetSession() {
                this.mode = 'mall';
                this.selectedIds = new Set();
                this.cart = {};
                this.mallTab = 'today';
                this.mallCat = null;
                this.save();
            }

            save() {
                const data = {
                    mode: this.mode,
                    selectedIds: Array.from(this.selectedIds),
                    cart: this.cart,
                    mallTab: this.mallTab,
                    mallCat: this.mallCat
                };
                localStorage.setItem('nh_sim_state', JSON.stringify(data));
                
                if (typeof app !== 'undefined' && app.state) {
                    renderManager.update();
                    ctaManager.update();
                }
            }

            toggleSelection(id) {
                if (this.selectedIds.has(id)) this.selectedIds.delete(id);
                else this.selectedIds.add(id);
                this.save();
            }

            addToCart(idList) {
                idList.forEach(id => {
                    if (!this.cart[id]) this.cart[id] = 1; 
                });
                this.selectedIds.clear(); 
                this.save();
            }
        }

        // --- T-G2: CTA State Machine ---
        const ctaManager = {
            btn: document.getElementById('mainCtaBtn'),
            
            update() {
                if (!app.state) return;

                const { mode, cart } = app.state;
                const cartCount = Object.keys(cart).length;
                
                let html = '';
                let className = 'main-cta-btn cta-default';

                // CTA Logic
                if (mode === 'mall') {
                    // Page 1
                    html = `<span class="cta-brand">ORDERZ</span><span>Ï£ºÎ¨∏ÌïòÎü¨ Í∞ÄÍ∏∞</span>`;
                } else {
                    // Page 2
                    if (cartCount === 0) {
                        html = `<span class="cta-brand">ORDERZ</span><span>ÏÉÅÌíàÏùÑ Îã¥ÏïÑ Ï£ºÏÑ∏Ïöî</span>`;
                    } else {
                        html = `<span class="cta-brand">ORDERZ</span><span>Îã¥ÏùÄ ÏÉÅÌíà ÌôïÏù∏</span>`;
                    }
                }

                this.btn.className = className;
                this.btn.innerHTML = html;
            }
        };

        // --- Render Manager ---
        const renderManager = {
            init() {
                this.renderCategories();
                this.attachScrollListener();
            },

            attachScrollListener() {
                const pageMall = document.getElementById('pageMall');
                const banner = document.getElementById('mallBanner');
                let lastScrollTop = 0;

                pageMall.addEventListener('scroll', () => {
                    const st = pageMall.scrollTop;
                    if (st > 20) {
                        banner.classList.add('collapsed');
                    } else {
                        banner.classList.remove('collapsed');
                    }
                    lastScrollTop = st <= 0 ? 0 : st;
                }, { passive: true });
            },

            renderCategories() {
                const container = document.getElementById('categoryNavArea');
                // UI Only: No Click Event
                container.innerHTML = CATEGORIES.map(c => `
                    <div class="mall-cat-item">
                        <div class="mall-cat-icon">${c.icon}</div>
                        <div class="mall-cat-text">${c.label}</div>
                    </div>
                `).join('');
            },

            update() {
                if (!app.state) return;

                const { mode, mallTab, mallCat, isSearchMode } = app.state;
                const modeBtn = document.getElementById('modeSwitchBtn');
                
                // Search Mode UI Toggle (CMD-A1)
                const catNav = document.getElementById('categoryNavArea');
                const searchBar = document.getElementById('searchBarArea');
                const banner = document.getElementById('mallBanner');
                const tabs = document.getElementById('mallTabs');
                
                if (isSearchMode) {
                    catNav.style.display = 'none';
                    searchBar.style.display = 'block';
                    banner.style.display = 'none'; 
                    tabs.style.display = 'none';   
                    
                    // Request: Maintain Mode Switcher even in Search Mode
                    // Do NOT change to Back button
                } else {
                    catNav.style.display = 'flex';
                    searchBar.style.display = 'none';
                    banner.style.display = 'block'; 
                    tabs.style.display = 'flex';    
                }

                // Normal Mode Btn Logic (Always applied)
                if (mode === 'mall') {
                    document.getElementById('pageMall').style.display = 'block';
                    document.getElementById('pageOrder').style.display = 'none';
                    this.renderMallList();
                    
                    // Display: "ÏÉÅÌíàÎ™©Î°ù" + Hamburger Icon
                    modeBtn.innerHTML = `
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"><line x1="3" y1="12" x2="21" y2="12"></line><line x1="3" y1="6" x2="21" y2="6"></line><line x1="3" y1="18" x2="21" y2="18"></line></svg>
                        <span>ÏÉÅÌíàÎ™©Î°ù</span>
                    `;
                } else {
                    document.getElementById('pageMall').style.display = 'none';
                    document.getElementById('pageOrder').style.display = 'block';
                    this.renderOrderList();

                    // Display: "Ï£ºÎ¨∏ÌïòÍ∏∞" + Checklist Icon
                    modeBtn.innerHTML = `
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"><path d="M16 4h2a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2V6a2 2 0 0 1 2-2h2"></path><rect x="8" y="2" width="8" height="4" rx="1" ry="1"></rect><path d="M9 14l2 2 4-4"></path></svg>
                        <span>Ï£ºÎ¨∏ÌïòÍ∏∞</span>
                    `;
                }

                document.querySelectorAll('.mall-sub-tab').forEach(el => {
                    const tabName = el.getAttribute('onclick').match(/'([^']+)'/)[1];
                    el.classList.toggle('active', tabName === mallTab);
                });
            },

            renderMallList() {
                const container = document.getElementById('mallListContainer');
                
                let items = RAW_DB;
                const { mallCat, mallTab, selectedIds, isSearchMode, searchQuery } = app.state;
                let summaryHtml = '';

                // Search Filtering (Overlay Mode)
                if (isSearchMode) {
                    if (searchQuery) {
                        items = items.filter(i => i.name.includes(searchQuery));
                    }
                    // CMD-B2: Search Summary Bar
                    summaryHtml = `
                        <div class="search-summary-bar">
                            <span class="search-keyword">${searchQuery}</span>
                            <span style="margin: 0 4px; color: #ccc;">¬∑</span>
                            <span style="color:#666; font-weight:400;">${items.length}Í∞ú ÏÉÅÌíà</span>
                        </div>
                    `;
                } else {
                    // Default Filtering
                    if (mallTab === 'today') items = items.filter(i => i.type === 'today');
                    else if (mallTab === 'store') items = items.filter(i => i.type === 'store');
                }

                if (items.length === 0) {
                    container.innerHTML = summaryHtml + `<div style="padding:40px; text-align:center; color:#999; font-size:13px;">${isSearchMode ? 'Í≤ÄÏÉâ Í≤∞Í≥ºÍ∞Ä ÏóÜÏäµÎãàÎã§.' : 'Ìï¥ÎãπÌïòÎäî ÏÉÅÌíàÏù¥ ÏóÜÏäµÎãàÎã§.'}</div>`;
                    return;
                }

                // CMD-B1: Use Existing Card UI
                const listHtml = items.map(item => {
                    const isSelected = selectedIds.has(item.id);
                    return `
                        <div class="product-item mall-item ${isSelected ? 'selected' : ''}" onclick="app.toggleSelect(${item.id})">
                            <div class="prod-chk-area">
                                <div class="prod-chk-square">
                                    <svg viewBox="0 0 24 24"><polyline points="20 6 9 17 4 12"></polyline></svg>
                                </div>
                            </div>
                            <div class="prod-content">
                                <div class="prod-img">${item.img}</div>
                                <div class="prod-info">
                                    <div class="prod-name">${item.name}</div>
                                    <div class="prod-unit">${item.unit}</div>
                                    <div class="prod-price">${item.price.toLocaleString()}Ïõê</div>
                                </div>
                            </div>
                        </div>
                    `;
                }).join('');

                container.innerHTML = summaryHtml + listHtml;
            },

            renderOrderList() {
                const container = document.getElementById('orderListContainer');
                const cartIds = Object.keys(app.state.cart);
                if(cartIds.length === 0) {
                    container.innerHTML = '<div style="padding:20px;">Îã¥Í∏¥ ÏÉÅÌíàÏù¥ ÏóÜÏäµÎãàÎã§.</div>';
                    return;
                }
                
                container.innerHTML = cartIds.map(id => {
                    const item = RAW_DB.find(p => p.id == id);
                    return `
                        <div class="product-item order-item">
                            <div class="prod-content">
                                <div class="prod-img">${item.img}</div>
                                <div class="prod-info">
                                    <div class="prod-name">${item.name}</div>
                                    <div class="prod-price">${item.price.toLocaleString()}Ïõê</div>
                                </div>
                            </div>
                        </div>
                    `;
                }).join('');
            }
        };

        // --- Application Controller ---
        const app = {
            state: new AppState(),

            init() {
                this.state.load();
                renderManager.init();
                ctaManager.update();
            },

            // --- Header Button Action (Dynamic) ---
            handleHeaderLeftBtn() {
                // Request: Maintain Mode Switch functionality even in search mode
                this.toggleModeWithGuide();
            },

            // --- Search Logic ---
            openSearch() {
                if (this.state.mode !== 'mall') return; // Only in Mall
                this.state.isSearchMode = true;
                renderManager.update();
                setTimeout(() => document.getElementById('searchInput').focus(), 100);
            },

            closeSearch() {
                this.state.isSearchMode = false;
                this.state.searchQuery = '';
                document.getElementById('searchInput').value = '';
                renderManager.update();
            },

            handleSearchInput(val) {
                this.state.searchQuery = val;
                renderManager.renderMallList(); // Local re-render
            },

            // --- Mode & Nav Logic ---
            toggleModeWithGuide() {
                this.toggleMode(); 
                const currentModeName = this.state.mode === 'mall' ? 'ÏÉÅÌíàÎ™©Î°ù' : 'Ï£ºÎ¨∏ÌïòÍ∏∞';
                const cm = document.getElementById('coachMark');
                cm.innerHTML = `ÏßÄÍ∏àÏùÄ <b>${currentModeName}</b> ÌôîÎ©¥ÏûÖÎãàÎã§.<br>Îã§Ïùå Ï†ëÏÜç Ïãú Ïù¥ ÌôîÎ©¥Î∂ÄÌÑ∞ ÏãúÏûëÌï¥Ïöî.`;
                cm.classList.add('show');
                setTimeout(() => cm.classList.remove('show'), 2500); 
            },

            toggleMode() {
                if (this.state.mode === 'mall') {
                    this.state.mode = 'order';
                    this.state.isSearchMode = false; // Auto-close search on switch
                } else {
                    this.state.mode = 'mall';
                }
                this.state.save(); 
            },
            
            resetHome() {
                this.state.mode = 'mall';
                this.state.mallTab = 'today';
                this.state.isSearchMode = false; // Reset search
                this.state.save();
            },

            setMallTab(tab) {
                this.state.mallTab = tab;
                this.state.save();
            },
            
            toggleSelect(id) {
                this.state.toggleSelection(id); 
            },

            handleCtaClick() {
                const { mode, selectedIds } = this.state;
                
                if (mode === 'mall') {
                    if (selectedIds.size > 0) {
                        this.state.addToCart(Array.from(selectedIds));
                    }
                    this.state.mode = 'order';
                    this.state.isSearchMode = false; // Ensure search is closed
                    this.state.save();
                } else {
                    this.state.mode = 'order'; 
                    this.state.save();
                }
            }
        };

        function showToast(msg) { /* Not used */ }

        window.onload = () => app.init();

    </script>
</body>
</html>
