<!DOCTYPE html>
<html lang="ko" translate="no">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="google" content="notranslate">
    <title>ORDERZ - NHÎùºÏù∏ Ï£ºÎ¨∏ ÏãúÎÆ¨Î†àÏù¥ÏÖò</title>
    <style>
        /* --- Reset & Base Styles --- */
        * { box-sizing: border-box; margin: 0; padding: 0; outline: none; -webkit-tap-highlight-color: transparent; }
        .goog-te-banner-frame { display: none !important; }
        .goog-tooltip { display: none !important; }
        .goog-text-highlight { background-color: transparent !important; border: none !important; box-shadow: none !important; }
        body { top: 0 !important; }
        html { height: 100%; }

        body { 
            background-color: #f5f5f5; 
            display: flex; 
            justify-content: center; 
            height: 100vh; 
            height: 100dvh; 
            min-height: -webkit-fill-available;
            color: #222; 
            font-family: -apple-system, BlinkMacSystemFont, "Apple SD Gothic Neo", "Malgun Gothic", sans-serif;
            overflow: hidden; 
        }
        
        /* --- Mobile Container Layout --- */
        .app-container {
            width: 100%; 
            max-width: 480px; 
            background-color: #fff; 
            position: relative;
            box-shadow: 0 0 20px rgba(0,0,0,0.05); 
            overflow: hidden; 
            display: flex; 
            flex-direction: column; 
            height: 100%; 
        }

        /* --- Colors & Vars --- */
        :root { 
            --primary: #1faa5e;        
            --primary-dark: #179c54;
            --primary-light: #e8f5e9; 
            --text-main: #111111;
            --text-sub: #767676;
            --border: #ececec;
            --bg-base: #fff;
            --bg-gray: #f8f9fa;
            --nav-height: 56px;
            --unified-bar-height: 76px; 
            --sidebar-width: 85%;
            --highlight-bg: #fffce0; 
        }

        /* --- Icons (SVG) --- */
        .icon { width: 24px; height: 24px; fill: none; stroke: currentColor; stroke-width: 2; stroke-linecap: round; stroke-linejoin: round; }

        /* --- Header --- */
        header { 
            height: 56px; padding: 0 12px; display: flex; justify-content: space-between; align-items: center; 
            background: #fff; z-index: 100; border-bottom: 1px solid var(--border);
            position: relative; flex-shrink: 0;
        }

        /* Header Left: Delivery Date */
        .header-delivery-btn {
            background: none; border: none; padding: 8px 4px; cursor: pointer;
            font-size: 13px; font-weight: 700; color: #444; letter-spacing: -0.5px;
            display: flex; align-items: center;
        }
        .header-delivery-btn:active { opacity: 0.6; }

        .header-center-title { 
            position: absolute; left: 50%; top: 50%; transform: translate(-50%, -50%); 
            font-size: 18px; font-weight: 800; color: var(--text-main); 
            letter-spacing: -0.5px;
            cursor: pointer; padding: 8px;
        }
        .header-center-title:active { opacity: 0.6; }

        .header-profile-group {
            display: flex; 
            flex-direction: row; 
            align-items: center; 
            justify-content: center;
            background: none; border: none; cursor: pointer;
            padding: 8px 6px; 
            margin-right: -4px;
        }
        .header-profile-group:active { opacity: 0.6; }
        
        .h-profile-icon { color: #222; width: 24px; height: 24px; margin-bottom: 2px; }
        .h-profile-text { 
            font-size: 13px; color: #444; font-weight: 700; letter-spacing: -0.5px;
            margin-right: 2px; white-space: nowrap; line-height: 1;
        }

        /* --- Tabs --- */
        .tab-bar { display: flex; background: #fff; border-bottom: 1px solid var(--border); height: 44px; flex-shrink: 0; z-index: 90; position: relative; }
        
        .tab-special-btn {
            flex: 0 0 50px; display: flex; align-items: center; justify-content: center;
            border-right: 1px solid #f0f0f0; cursor: pointer; color: #ccc; background: #fff;
            transition: all 0.2s;
        }
        .tab-special-btn.active { color: #ffca28; }
        .tab-special-btn svg { width: 22px; height: 22px; fill: currentColor; stroke: none; } 
        
        .tab { 
            flex: 1; display: flex; align-items: center; justify-content: center; 
            font-size: 14px; color: #888; cursor: pointer; font-weight: 500; 
            transition: all 0.2s; position: relative; letter-spacing: -0.3px;
        }
        .tab.active { color: var(--primary); font-weight: 800; }
        .tab.active::after { 
            content: ''; position: absolute; bottom: 0; left: 0; width: 100%; height: 3px; 
            background: var(--primary); 
        }

        /* Right End Sort Button in Tabs */
        .tab-sort-btn {
            flex: 0 0 44px; display: flex; align-items: center; justify-content: center;
            cursor: pointer; border-left: 1px solid #f5f5f5; color: #666; 
        }
        .tab-sort-btn:active { background: #f9f9f9; }
        .tab-sort-icon-display { font-size: 18px; font-weight: 400; line-height: 1; pointer-events: none; }

        /* Sort Dropdown Menu */
        .sort-dropdown-menu {
            position: absolute; top: 44px; right: 4px; 
            background: #fff; border-radius: 8px; 
            box-shadow: 0 4px 16px rgba(0,0,0,0.15); border: 1px solid #eee;
            width: 160px; display: none; flex-direction: column; overflow: hidden;
            z-index: 1001;
        }
        .sort-dropdown-menu.show { display: flex; animation: fadeIn 0.1s ease-out; }
        
        .sort-menu-item {
            padding: 12px 16px; font-size: 14px; font-weight: 500; color: #333;
            background: #fff; border: none; text-align: left; cursor: pointer;
            border-bottom: 1px solid #f9f9f9; display: flex; align-items: center; gap: 8px;
            width: 100%;
        }
        .sort-menu-item:last-child { border-bottom: none; }
        .sort-menu-item:active { background: #f5f5f5; }
        .sort-menu-item.active { font-weight: 700; color: var(--primary); background: #f0fdf4; }
        .sort-menu-item-icon { font-size: 16px; width: 18px; text-align: center; }

        .sort-menu-divider { height: 1px; background: #eee; margin: 4px 0; pointer-events: none; }
        .sort-menu-item.manage-item { color: #555; font-size: 13px; font-weight: 600; background: #fafafa; justify-content: space-between; }
        .sort-menu-item.manage-item svg { color: #888; width: 15px; height: 15px; }

        /* --- Content Area --- */
        .content-scroll { 
            flex: 1; overflow-y: auto; background: #fff; 
            padding-bottom: calc(var(--unified-bar-height) + 30px + env(safe-area-inset-bottom)); 
            -webkit-overflow-scrolling: touch; 
        }
        
        /* --- Product List Item --- */
        .product-item { 
            display: flex; padding: 20px 16px; 
            border-bottom: 1px solid #f0f0f0; align-items: flex-start; 
            background: #fff; transition: background-color 0.2s;
        }
        .product-item.selected { background-color: #f0fdf4; }
        .product-item.is-new-item { background-color: var(--highlight-bg); }

        .main-section-header {
            background: #f8f9fa; color: #333; font-size: 14px; font-weight: 800;
            padding: 12px 16px; border-bottom: 1px solid #eee; border-top: 1px solid #eee;
            margin-top: -1px; display: flex; align-items: center;
        }
        .main-section-header.special-header { background: #fff8f8; color: #d63031; border-top: 4px solid #f1f3f5; }
        .main-section-header::before {
            content: ''; display: inline-block; width: 4px; height: 14px;
            background: var(--primary); margin-right: 8px; border-radius: 2px;
        }
        .main-section-header.special-header::before { background: #d63031; }

        .prod-img { 
            width: 72px; height: 72px; background: #f8f9fa; border: 1px solid #eee; border-radius: 8px; 
            margin-right: 16px; display: flex; align-items: center; justify-content: center; 
            font-size: 32px; flex-shrink: 0; 
        }

        .prod-info { flex: 1; min-width: 0; display: flex; flex-direction: column; padding-top: 2px; }
        .prod-name { 
            font-size: 16px; font-weight: 600; color: #111; 
            margin-bottom: 4px; line-height: 1.35; 
            overflow: hidden; text-overflow: ellipsis; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; 
            letter-spacing: -0.5px;
        }
        .prod-unit { font-size: 12px; color: #999; margin-bottom: 8px; font-weight: 500; }
        .prod-bottom { display: flex; align-items: flex-end; justify-content: space-between; margin-top: auto; }
        .prod-price { font-size: 17px; font-weight: 800; color: #111; letter-spacing: -0.5px; }

        /* --- Unified Bottom Bar --- */
        .unified-bottom-bar {
            position: absolute; bottom: 0; left: 0; width: 100%;
            height: calc(var(--unified-bar-height) + env(safe-area-inset-bottom));
            background: #fff; border-top: 1px solid #eee;
            box-shadow: 0 -4px 16px rgba(0,0,0,0.06);
            z-index: 1000; display: flex; align-items: center; justify-content: space-between;
            padding: 0 12px env(safe-area-inset-bottom); gap: 8px; 
        }

        .nav-side-btn {
            flex: 1; height: 50px; border-radius: 12px; background: #fff; border: none;
            display: flex; align-items: center; justify-content: center;
            cursor: pointer; color: #555; transition: all 0.2s;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05); 
        }
        .center-main-btn {
            flex: 1; height: 50px; background: #fff; border: none; border-radius: 12px;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            cursor: not-allowed; box-shadow: 0 2px 8px rgba(0,0,0,0.05);
            transition: all 0.2s; padding: 0 4px; min-width: 0; position: relative;
        }
        .btn-brand-text { color: var(--primary); font-family: Arial; font-weight: 900; font-size: 10px; line-height: 1.1; margin-bottom: 3px; }
        .btn-action-text { color: #111; font-size: 13px; font-weight: 700; letter-spacing: -0.8px; line-height: 1.1; white-space: nowrap; }
        .center-main-btn.active { background: #f0fdf4; cursor: pointer; box-shadow: 0 4px 12px rgba(31, 170, 94, 0.2); }

        /* --- Editor Modal --- */
        .editor-modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #fff; z-index: 2000; transform: translateY(100%); transition: transform 0.3s; display:flex; flex-direction:column; }
        .editor-modal.open { transform: translateY(0); }
        .editor-header { height: 56px; border-bottom:1px solid #eee; display:flex; align-items:center; justify-content:center; font-weight:700; position:relative; }
        .editor-close { position:absolute; right:16px; background:none; border:none; color:#555; cursor: pointer; }
        .editor-sort-bar { display: flex; height: 50px; padding: 0 16px; border-bottom: 1px solid #eee; align-items: center; gap: 12px; }
        .editor-action-btn { display: flex; align-items: center; gap: 4px; padding: 6px 10px; background: #f5f5f5; border: 1px solid #eee; border-radius: 6px; font-size: 12px; font-weight: 600; color: #555; cursor: pointer; }
        .col-header-btn { width: 100%; height: 34px; display: flex; align-items: center; justify-content: center; font-size: 11px; font-weight: 700; color: #888; border: 1px solid #eee; border-radius: 6px; cursor: pointer; }
        .col-header-btn.active { background: #333; color: #fff; border-color: #333; }
        .editor-row { display: grid; grid-template-columns: 32px 1fr 50px 50px 50px; gap: 4px; padding: 10px; border-bottom: 1px solid #f2f4f6; align-items: center; }
        .editor-input { width: 100%; height: 36px; border: 1px solid #e0e0e0; border-radius: 6px; text-align: center; font-size: 15px; font-weight: 700; outline: none; }
        .editor-bottom-bar { height: 60px; display: flex; padding: 8px 16px; gap: 10px; background: #fff; border-top: 1px solid #eee; flex-shrink: 0; padding-bottom: env(safe-area-inset-bottom); }
        .editor-btn-save { flex: 1; border: none; background: #333; color: #fff; border-radius: 8px; font-weight: 600; cursor: pointer; }

        /* Toast & Animations */
        .toast-msg { position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background: rgba(0,0,0,0.85); color: white; padding: 14px 24px; border-radius: 30px; font-size: 14px; z-index: 3000; opacity: 0; transition: opacity 0.3s; pointer-events: none; }
        .toast-msg.show { opacity: 1; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(-5px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body>

    <div class="app-container">
        <header>
            <button class="header-delivery-btn" onclick="showToast('Î∞∞ÏÜ°Ïùº Î≥ÄÍ≤Ω ÌåùÏóÖ')">
                10/20 (Ïõî) Î∞∞ÏÜ° &gt;
            </button>
            <div class="header-center-title" onclick="resetToHome()">NHÎùºÏù∏</div>
            <button class="header-profile-group" onclick="showToast('Îß§Ïû• Î≥ÄÍ≤Ω ÌåùÏóÖ')">
                <div class="h-profile-text">Í∞ïÎÇ® 1Ìò∏Ï†ê ‚ñæ</div>
                <svg class="icon h-profile-icon" viewBox="0 0 24 24"><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path><circle cx="12" cy="7" r="4"></circle></svg>
            </button>
        </header>

        <div class="tab-bar">
            <div class="tab-special-btn" onclick="switchTab('special')" id="tab-special">
                <svg viewBox="0 0 24 24"><path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z"></path></svg>
            </div>
            
            <div class="tab active" onclick="switchTab('list1')" id="tab-list1">LIST 1</div>
            <div class="tab" onclick="switchTab('list2')" id="tab-list2">LIST 2</div>
            <div class="tab" onclick="switchTab('list3')" id="tab-list3">LIST 3</div>

            <div class="tab-sort-btn" id="tabSortBtn" onclick="toggleSortMenu()">
                <div class="tab-sort-icon-display" id="tabSortIcon">‚Üó</div>
                
                <!-- Sort Menu Dropdown -->
                <div class="sort-dropdown-menu" id="sortDropdown">
                    <button class="sort-menu-item active" id="menu-sort-latest" onclick="selectSortMode('latest', event)">
                        <span class="sort-menu-item-icon">‚Üó</span> ÏµúÏã†Ïàú
                    </button>
                    <button class="sort-menu-item" id="menu-sort-category" onclick="selectSortMode('category', event)">
                        <span class="sort-menu-item-icon">‚ò∞</span> Ïπ¥ÌÖåÍ≥†Î¶¨Ïàú
                    </button>
                    <button class="sort-menu-item" id="menu-sort-custom" onclick="selectSortMode('custom', event)">
                        <span class="sort-menu-item-icon">‚ô°</span> ÎßàÏù¥Î¶¨Ïä§Ìä∏
                    </button>
                    <div class="sort-menu-divider"></div>
                    <button class="sort-menu-item manage-item" onclick="openEditorFromMenu(event)">
                        <span>Î¶¨Ïä§Ìä∏ Í¥ÄÎ¶¨</span>
                        <svg class="icon" viewBox="0 0 24 24"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path></svg>
                    </button>
                </div>
            </div>
        </div>

        <div class="content-scroll" id="scrollContainer">
            <div id="mainProductList"></div>
        </div>

        <div class="unified-bottom-bar">
            <button class="nav-side-btn" onclick="showToast('Í≤ÄÏÉâÏ∞Ω Ïó¥Í∏∞')">
                <svg class="icon" viewBox="0 0 24 24"><circle cx="11" cy="11" r="8"></circle><line x1="21" y1="21" x2="16.65" y2="16.65"></line></svg>
            </button>
            <button class="center-main-btn" id="mainOrderBtn" onclick="showToast('Ï£ºÎ¨∏ÏÑú Ïù¥Îèô')">
                <span class="btn-brand-text">ORDERZ</span>
                <span class="btn-action-text" id="orderBtnText">ÏÉÅÌíàÏùÑ Îã¥ÏïÑÏ£ºÏÑ∏Ïöî</span>
            </button>
            <button class="nav-side-btn" onclick="showToast('Î¨∏ÏùòÌïòÍ∏∞ Ïó∞Í≤∞')">
                <svg class="icon" viewBox="0 0 24 24"><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"></path></svg>
            </button>
        </div>
    </div>

    <!-- Editor Modal -->
    <div class="editor-modal" id="editorModal">
        <div class="editor-header">
            Î¶¨Ïä§Ìä∏ Í¥ÄÎ¶¨
            <button class="editor-close" onclick="closeEditor()">Îã´Í∏∞</button>
        </div>
        <div class="editor-top-area">
            <div class="editor-sort-bar">
                <div style="display:flex; gap:8px; margin-right:auto;">
                    <button class="editor-action-btn" onclick="showToast('Ìé∏Ïßë Í∞ÄÏù¥Îìú ÎÖ∏Ï∂ú')">Í∞ÄÏù¥Îìú</button>
                    <button class="editor-action-btn" onclick="showToast('Î¶¨Ïä§Ìä∏Î™Ö Î≥ÄÍ≤Ω')">Ïù¥Î¶ÑÎ≥ÄÍ≤Ω</button>
                </div>
                <div style="display:flex; gap:4px;">
                    <div class="col-header-btn" id="h-list1" onclick="focusEditorList('list1')">L1</div>
                    <div class="col-header-btn" id="h-list2" onclick="focusEditorList('list2')">L2</div>
                    <div class="col-header-btn" id="h-list3" onclick="focusEditorList('list3')">L3</div>
                </div>
            </div>
        </div>
        <div class="content-scroll" id="editorList"></div>
        <div class="editor-bottom-bar">
            <button class="editor-btn-save" onclick="saveSort()">Ï†ÄÏû•ÌïòÍ∏∞</button>
        </div>
    </div>

    <script>
        function showToast(msg) {
            let toast = document.createElement('div');
            toast.className = 'toast-msg show';
            toast.innerText = msg;
            document.body.appendChild(toast);
            setTimeout(() => { toast.classList.remove('show'); setTimeout(()=>toast.remove(), 300); }, 2000);
        }

        const CATEGORY_CODES = { "Ï±ÑÏÜå.Í≥ºÏùº": 10, "ÏàòÏÇ∞.Ï∂ïÏÇ∞": 20, "ÏãùÌíà.ÏùåÎ£å": 30, "ÏñëÎÖê.ÏÜåÏä§": 40, "Ï£ºÎ∞©.Ïû°Ìôî": 50, "Í∏∞ÌÉÄ": 99 };
        const productsData = {
            'special': [
                { id: 1001, name: "[ÌäπÍ∞Ä] Îã§Î∂ÄÎ¶¨ Î∞∞Ï∂î 4Ìè¨Í∏∞ BOX", unit: "BOX", price: 12500, img: "ü•¨", theme: "üî• ÏÇ¨Ïû•Îãò Í∞ïÎ†• Ï∂îÏ≤ú" },
                { id: 1003, name: "Ï≤≠ÏñëÍ≥†Ï∂î (Ìäπ) 10kg", unit: "BOX", price: 45000, img: "üå∂Ô∏è", theme: "ü•¨ Ï†úÏ≤† Ïã†ÏÑ† ÏãùÌíà" }
            ],
            'list1': [
                { id: 1, name: "ÏñëÎ∞∞Ï∂î(ÎåÄ) 3ÏûÖ BOX", unit: "BOX", price: 10900, img: "ü•¶", category: "Ï±ÑÏÜå.Í≥ºÏùº" },
                { id: 2, name: "ÏñëÌåå Ïôï 20kgÎßù BOX", unit: "BOX", price: 22000, img: "üßÖ", category: "Ï±ÑÏÜå.Í≥ºÏùº" },
                { id: 3001, name: "CJ ÌñáÎ∞ò 24ÏûÖ", unit: "BOX", price: 21900, img: "üçö", category: "ÏãùÌíà.ÏùåÎ£å" }
            ],
            'list2': [ { id: 2001, name: "ÏÇ¨Í≥º 10kg", unit: "BOX", price: 42000, img: "üçé", category: "Ï±ÑÏÜå.Í≥ºÏùº" } ],
            'list3': [ { id: 3002, name: "Ïã†ÎùºÎ©¥ 30ÏûÖ BOX", unit: "BOX", price: 24500, img: "üçú", category: "ÏãùÌíà.ÏùåÎ£å" } ]
        };

        let userSortData = { 'list1': {}, 'list2': {}, 'list3': {}, 'special': {} };
        let currentTab = 'list1';
        let viewerSortMode = 'latest';
        let editorFocusList = 'list1';
        let allEditorItems = [];

        function init() {
            initSortData();
            switchTab('list1');
        }

        function initSortData() {
            let now = Date.now();
            ['list1', 'list2', 'list3', 'special'].forEach(key => {
                productsData[key].forEach((p, idx) => {
                    userSortData[key][p.id] = { order: null, addedAt: now - (idx * 1000) };
                });
            });
        }

        function getExtendedList(tab) {
            return productsData[tab].map(p => ({
                ...p,
                order: userSortData[tab][p.id]?.order || null,
                addedAt: userSortData[tab][p.id]?.addedAt || 0
            }));
        }

        function switchTab(tab) {
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.getElementById('tab-special').classList.remove('active');
            if (tab === 'special') document.getElementById('tab-special').classList.add('active');
            else document.getElementById(`tab-${tab}`).classList.add('active');
            
            currentTab = tab;
            renderMainList();
        }

        function toggleSortMenu() {
            const menu = document.getElementById('sortDropdown');
            const isShow = menu.classList.contains('show');
            if(isShow) {
                menu.classList.remove('show');
                setTimeout(() => menu.style.display = 'none', 100);
            } else {
                menu.style.display = 'flex';
                setTimeout(() => menu.classList.add('show'), 10);
            }
        }

        // Î©îÎâ¥ ÏÑ†ÌÉù Ïãú ÏûêÎèô Îã´Í∏∞ Î∞è Ïù¥Î≤§Ìä∏ Ï†ÑÌåå Î∞©ÏßÄ
        function selectSortMode(mode, event) {
            if(event) event.stopPropagation(); // Î∂ÄÎ™® ÌÜ†Í∏Ä Ïù¥Î≤§Ìä∏ Î∞©ÏßÄ
            
            const list = getExtendedList(currentTab);
            const menu = document.getElementById('sortDropdown');

            if (mode === 'custom' && !list.some(i => i.order !== null)) {
                showToast("ÎßàÏù¥Î¶¨Ïä§Ìä∏ ÏàúÏÑúÍ∞Ä ÏóÜÏäµÎãàÎã§. Î¶¨Ïä§Ìä∏ Í¥ÄÎ¶¨ÏóêÏÑú ÏÑ§Ï†ïÌï¥ Ï£ºÏÑ∏Ïöî.");
                toggleSortMenu(); // Ïò§Î•ò Î¨∏Íµ¨ Î≥¥Ïó¨Ï£ºÍ≥† Î©îÎâ¥ Îã´Í∏∞
                return;
            }
            
            viewerSortMode = mode;
            updateSortIcon();
            renderMainList();
            toggleSortMenu(); // ÏÑ±Í≥µ Ïãú Î©îÎâ¥ Îã´Í∏∞
        }

        function openEditorFromMenu(event) {
            if(event) event.stopPropagation(); // Î∂ÄÎ™® ÌÜ†Í∏Ä Ïù¥Î≤§Ìä∏ Î∞©ÏßÄ
            toggleSortMenu(); // Î©îÎâ¥ Îã´Í∏∞
            openEditor();
        }

        function updateSortIcon() {
            const icons = { latest: '‚Üó', category: '‚ò∞', custom: '‚ô°' };
            document.getElementById('tabSortIcon').innerText = icons[viewerSortMode];
            document.querySelectorAll('.sort-menu-item').forEach(item => {
                item.classList.remove('active');
                if(item.id === `menu-sort-${viewerSortMode}`) item.classList.add('active');
            });
        }

        function renderMainList() {
            const list = getExtendedList(currentTab);
            const container = document.getElementById('mainProductList');
            container.innerHTML = '';

            if (currentTab === 'special') {
                list.sort((a,b) => a.theme.localeCompare(b.theme));
                renderItems(list, container, true, 'theme');
            } else if (viewerSortMode === 'latest') {
                list.sort((a,b) => b.addedAt - a.addedAt);
                renderItems(list, container);
            } else if (viewerSortMode === 'category') {
                list.sort((a,b) => (CATEGORY_CODES[a.category] || 99) - (CATEGORY_CODES[b.category] || 99));
                renderItems(list, container, true, 'category');
            } else {
                list.sort((a,b) => (a.order || 999) - (b.order || 999));
                renderItems(list, container);
            }
        }

        function renderItems(items, container, showHeader = false, groupKey = '') {
            let lastGroup = null;
            items.forEach(item => {
                if (showHeader && item[groupKey] !== lastGroup) {
                    const h = document.createElement('div');
                    h.className = currentTab === 'special' ? 'main-section-header special-header' : 'main-section-header';
                    h.innerText = item[groupKey];
                    container.appendChild(h);
                    lastGroup = item[groupKey];
                }
                const div = document.createElement('div');
                div.className = 'product-item';
                div.innerHTML = `<div class="prod-img">${item.img}</div><div class="prod-info"><div class="prod-name">${item.name}</div><div class="prod-price">${item.price.toLocaleString()}Ïõê</div></div>`;
                container.appendChild(div);
            });
        }

        function openEditor() {
            allEditorItems = [];
            ['list1', 'list2', 'list3'].forEach(l => {
                getExtendedList(l).forEach(i => allEditorItems.push({...i, tempListId: l}));
            });
            editorModal.classList.add('open');
            focusEditorList('list1');
        }

        function focusEditorList(id) {
            editorFocusList = id;
            document.querySelectorAll('.col-header-btn').forEach(b => b.classList.remove('active'));
            document.getElementById(`h-${id}`).classList.add('active');
            renderEditor();
        }

        function renderEditor() {
            const container = document.getElementById('editorList');
            container.innerHTML = '';
            allEditorItems.filter(i => i.tempListId === editorFocusList).forEach(item => {
                const row = document.createElement('div');
                row.className = 'editor-row';
                row.innerHTML = `<div style="font-size:12px; color:#ccc;">üóëÔ∏è</div><div style="font-size:13px;">${item.name}</div><div></div><div></div><input type="number" class="editor-input" value="${item.order||''}" onchange="updateTempOrder(${item.id}, this.value)">`;
                container.appendChild(row);
            });
        }

        function updateTempOrder(id, val) {
            const item = allEditorItems.find(i => i.id === id);
            if(item) item.order = val ? parseInt(val) : null;
        }

        function saveSort() {
            ['list1', 'list2', 'list3'].forEach(l => {
                allEditorItems.filter(i => i.tempListId === l).forEach(item => {
                    userSortData[l][item.id].order = item.order;
                });
            });
            showToast("Ï†ÄÏû•ÎêòÏóàÏäµÎãàÎã§.");
            closeEditor();
            renderMainList();
        }

        function closeEditor() { editorModal.classList.remove('open'); }
        function resetToHome() { document.getElementById('scrollContainer').scrollTo({top:0, behavior:'smooth'}); }
        
        // Ïô∏Î∂Ä ÌÅ¥Î¶≠ Ïãú Î©îÎâ¥ Îã´Í∏∞
        document.addEventListener('click', (e) => {
            const menu = document.getElementById('sortDropdown');
            if(!e.target.closest('#tabSortBtn') && menu.classList.contains('show')) {
                toggleSortMenu();
            }
        });

        window.onload = init;
    </script>
</body>
</html>
